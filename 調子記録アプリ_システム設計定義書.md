# 調子記録アプリ システム設計定義書

## 目次

1. [システム概要](#1-システム概要)
2. [技術スタック](#2-技術スタック)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [データベース設計](#4-データベース設計)
5. [API設計](#5-api設計)
6. [バックエンド構造](#6-バックエンド構造)
7. [フロントエンド構造](#7-フロントエンド構造)
8. [認証・認可](#8-認証認可)
9. [外部API連携](#9-外部api連携)
10. [データフロー](#10-データフロー)
11. [主要機能詳細](#11-主要機能詳細)
12. [実装状況と課題](#12-実装状況と課題)
13. [開発ロードマップ](#13-開発ロードマップ)

---

## 1. システム概要

### 1.1 アプリケーション名
**Mood Tracker - AIを活用した調子記録アプリ**

### 1.2 目的
ユーザーが日々の調子を記録し、AIによる分析とアドバイスを受けることで、自己理解を深め、より良い生活習慣を構築することを支援するWebアプリケーション。

### 1.3 主要機能
- ユーザー認証（登録・ログイン）
- 調子データの記録（体調、気分、活動内容など）
- 自己分析質問への回答（10段階評価）
- **AI質問生成機能（分析観点に基づく動的な質問生成）** ✅ **実装済み**
- 気象データの自動取得・記録
- ダッシュボードでのデータ可視化（グラフ表示）
- 記録の一覧表示・詳細表示
- AIによるデータ分析とアドバイス生成（今後実装予定）

### 1.4 ターゲットユーザー
自己管理を行いたい個人ユーザー

### 1.5 開発環境
- **OS**: Windows 11 24H2
- **エディタ**: VSCode
- **プロジェクトパス**: E:\ReactProject\
- **無償ツールのみ使用**

---

## 2. 技術スタック

### 2.1 フロントエンド
| 技術 | バージョン | 用途 | 実装状況 |
|------|-----------|------|---------|
| React | 18.x | UIライブラリ | ✅ 実装済み |
| TypeScript | 5.x | 型安全な開発 | ✅ 実装済み |
| Vite | 5.x | ビルドツール・開発サーバー | ✅ 実装済み |
| Axios | 1.x | HTTP通信 | ✅ 実装済み |
| Chart.js | 4.x | データ可視化 | ✅ 実装済み |
| React Icons | 5.x | アイコン表示 | ✅ 実装済み |

### 2.2 バックエンド
| 技術 | バージョン | 用途 | 実装状況 |
|------|-----------|------|---------|
| Node.js | 20.x LTS | ランタイム環境 | ✅ 実装済み |
| Express | 4.x | Webフレームワーク | ✅ 実装済み |
| TypeScript | 5.x | 型安全な開発 | ✅ 実装済み |
| pg (node-postgres) | 8.x | PostgreSQLクライアント | ✅ 実装済み |
| bcrypt | 5.x | パスワードハッシュ化 | ✅ 実装済み |
| jsonwebtoken | 9.x | JWT認証 | ✅ 実装済み |
| express-validator | 7.x | バリデーション | ✅ 実装済み |
| dotenv | 16.x | 環境変数管理 | ✅ 実装済み |
| @google/generative-ai | 最新 | Gemini API連携 | ✅ 実装済み |

### 2.3 データベース
| 技術 | バージョン | 用途 | 実装状況 |
|------|-----------|------|---------|
| PostgreSQL | 16.x | リレーショナルデータベース | ✅ 実装済み |

### 2.4 外部API
| サービス | 用途 | 実装状況 |
|---------|------|---------|
| Google Gemini API | AI分析・質問生成・アドバイス生成 | 🔄 部分実装（質問生成完了） |
| WeatherAPI | 気象データ取得 | ✅ 実装済み |

### 2.5 開発ツール
| ツール | 用途 |
|--------|------|
| VSCode | エディタ |
| Git | バージョン管理 |
| npm | パッケージ管理 |

---

## 3. システムアーキテクチャ

### 3.1 全体構成

```
┌─────────────────┐
│   ブラウザ      │
│   (React)       │
└────────┬────────┘
         │ HTTP/HTTPS
         │ (REST API)
         │
┌────────┴────────┐
│ Express Server  │
│   (Node.js)     │
└────────┬────────┘
         │
    ┌────┴────┬────────────┬────────────┐
    │         │            │            │
┌───┴───┐ ┌──┴──────┐ ┌──┴─────────┐ │
│PostgreSQL│ │Gemini API│ │WeatherAPI│ │
│         │ │(質問生成)│ │          │ │
└─────────┘ └─────────┘ └──────────┘ │
              ✅ 実装済み   ✅ 実装済み │
```

### 3.2 アーキテクチャパターン
- **フロントエンド**: コンポーネントベースアーキテクチャ
- **バックエンド**: MVC（Model-View-Controller）パターン
- **通信**: RESTful API
- **認証**: JWT（JSON Web Token）ベース

### 3.3 レイヤー構成

#### フロントエンド
```
Presentation Layer (Components)
        ↓
Service Layer (API Clients)
        ↓
HTTP Client (Axios)
```

#### バックエンド
```
Route Layer (ルーティング)
        ↓
Controller Layer (ビジネスロジック)
        ↓
Model Layer (データアクセス)
        ↓
Database (PostgreSQL)
```

---

## 4. データベース設計

### 4.1 ER図

```
┌──────────────┐
│    users     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────┴───────┐
│   records    │
└──────────────┘
       │ 1
       ├─────────────────────┐
       │                     │
       │ N                   │ N
┌──────┴──────────┐  ┌──────┴─────────┐
│analysis_answers │  │  weather_data  │
└─────────────────┘  └────────────────┘
       │ N
       │
       │ 1
┌──────┴──────────────┐
│analysis_questions   │ ✅ AI生成質問対応
└─────────────────────┘
       │ N
       │
       │ 1
┌──────┴──────────────┐
│analysis_categories  │
└─────────────────────┘

┌──────────────┐
│    users     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────┴───────────┐
│advice_history    │
└──────────────────┘
```

### 4.2 テーブル定義

#### 4.2.1 users（ユーザー情報）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | ユーザーID（自動採番） |
| username | VARCHAR(50) | UNIQUE NOT NULL | ユーザー名 |
| email | VARCHAR(255) | UNIQUE NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ値 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**: なし（PRIMARY KEYとUNIQUE制約により自動作成）

---

#### 4.2.2 records（記録データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 記録ID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| recorded_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 記録日時 |
| sleep_hours | DECIMAL(3,1) | NULL | 睡眠時間（時間） |
| sleep_quality | INTEGER | CHECK (1～10), NULL | 睡眠の質（10段階） |
| meal_quality | INTEGER | CHECK (1～10), NULL | 食事の質（10段階） |
| meal_regularity | INTEGER | CHECK (1～10), NULL | 食事の規則性（10段階） |
| exercise_minutes | INTEGER | NULL | 運動時間（分） |
| exercise_intensity | INTEGER | CHECK (1～10), NULL | 運動強度（10段階） |
| emotion_score | INTEGER | CHECK (1～10), NULL | 感情スコア（10段階） |
| emotion_note | TEXT | NULL | 感情に関するメモ |
| motivation_score | INTEGER | CHECK (1～10), NULL | モチベーション（10段階） |
| activities_done | TEXT | NULL | やったこと（自由記述） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_records_user_id` ON (user_id)
- `idx_records_recorded_at` ON (recorded_at)

---

#### 4.2.3 analysis_categories（分析観点マスタ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 観点ID（自動採番） |
| code | VARCHAR(50) | UNIQUE NOT NULL | 観点コード |
| name | VARCHAR(100) | NOT NULL | 観点名称 |
| description | TEXT | NULL | 説明 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**初期データ**:
- code='sleep', name='睡眠', description='睡眠の質や時間に関する分析'
- code='exercise', name='運動', description='運動習慣や身体活動に関する分析'
- code='nutrition', name='栄養', description='食事の質や栄養バランスに関する分析'

---

#### 4.2.4 analysis_questions（質問マスタ） ✅ **AI生成対応**

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 質問ID（自動採番） |
| category_id | INTEGER | NOT NULL, REFERENCES analysis_categories(id) ON DELETE CASCADE | 分析観点ID |
| question_text | TEXT | NOT NULL | 質問文 |
| is_active | BOOLEAN | DEFAULT true | 有効フラグ |
| generated_by_ai | BOOLEAN | DEFAULT false | **AI生成フラグ** ✅ |
| usage_count | INTEGER | DEFAULT 0 | 使用回数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
- `idx_questions_category_id` ON (category_id)
- `idx_questions_is_active` ON (is_active)

**AI生成質問の実装** ✅:
- `generated_by_ai = true` で保存
- Gemini API により分析観点に基づいて動的に生成
- 各カテゴリーにつき5つの質問を生成

**初期データ（手動作成質問の例）**:
- 睡眠カテゴリー:
  - 「昨晩の睡眠時間は十分でしたか？」
  - 「目覚めたとき、気分はどうでしたか？」
  - 「夜中に何度も目が覚めましたか？」
- 運動カテゴリー:
  - 「今日は運動をしましたか？」
  - 「運動後、気分はリフレッシュしましたか？」
  - 「運動の強度は適切でしたか？」
- 栄養カテゴリー:
  - 「今日の食事は栄養バランスが取れていましたか？」
  - 「食事の時間は規則的でしたか？」
  - 「食事の量は適切でしたか？」

---

#### 4.2.5 analysis_answers（回答データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 回答ID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| record_id | INTEGER | REFERENCES records(id) ON DELETE CASCADE, NULL | 記録ID（任意） |
| question_id | INTEGER | NOT NULL, REFERENCES analysis_questions(id) ON DELETE CASCADE | 質問ID |
| answer_score | INTEGER | NOT NULL, CHECK (1～10) | 回答スコア（10段階） |
| answered_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 回答日時 |

**インデックス**:
- `idx_answers_user_id` ON (user_id)
- `idx_answers_record_id` ON (record_id)
- `idx_answers_question_id` ON (question_id)
- `idx_answers_answered_at` ON (answered_at)

---

#### 4.2.6 weather_data（気象データ）

| カラム名 | データ型 | 制約 | 説明 | 実装状況 |
|---------|---------|------|------|---------|
| id | SERIAL | PRIMARY KEY | 気象データID（自動採番） | ✅ 実装済み |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID | ✅ 実装済み |
| recorded_at | TIMESTAMP | NOT NULL | 記録日時 | ✅ 実装済み |
| temperature | DECIMAL(4,1) | NULL | 気温（℃） | ✅ 実装済み |
| humidity | INTEGER | NULL | 湿度（%） | ✅ 実装済み |
| pressure | DECIMAL(6,2) | NULL | 気圧（hPa） | ⚠️ 未使用 |
| weather_condition | VARCHAR(100) | NULL | 天気の状態 | ✅ 実装済み |
| weather_description | TEXT | NULL | 詳細な天気説明 | ⚠️ 未使用 |
| season | VARCHAR(20) | NULL | 季節 | ⚠️ 未使用 |
| location | VARCHAR(255) | NULL | 位置情報 | ✅ 実装済み（'Tokyo'固定） |
| api_source | VARCHAR(50) | NULL | データ取得元API | ⚠️ 未使用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 | ✅ 実装済み |

**インデックス**:
- `idx_weather_user_id` ON (user_id)
- `idx_weather_recorded_at` ON (recorded_at)

**実装メモ**:
- 実際に保存されるデータ: user_id, temperature, humidity, weather_condition, location, recorded_at
- pressure, weather_description, season, api_source は現在未使用
- location は 'Tokyo' で固定（今後の改善候補）

---

#### 4.2.7 advice_history（アドバイス履歴）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | アドバイスID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| advice_text | TEXT | NOT NULL | アドバイス本文 |
| advice_type | VARCHAR(50) | NULL | アドバイスの種類 |
| based_on_data | JSONB | NULL | 生成に使用したデータ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| displayed_at | TIMESTAMP | NULL | 表示日時 |
| was_helpful | BOOLEAN | NULL | 役立ったかのフィードバック |

**インデックス**:
- `idx_advice_user_id` ON (user_id)
- `idx_advice_created_at` ON (created_at)

---

### 4.3 リレーションシップ

#### 主要な関係性

1. **users → records**: 1対多（1ユーザーは複数の記録を持つ）
2. **users → analysis_answers**: 1対多（1ユーザーは複数の回答を持つ）
3. **users → weather_data**: 1対多（1ユーザーは複数の気象データを持つ）
4. **users → advice_history**: 1対多（1ユーザーは複数のアドバイスを受ける）
5. **analysis_categories → analysis_questions**: 1対多（1観点は複数の質問を持つ）
6. **analysis_questions → analysis_answers**: 1対多（1質問は複数の回答を持つ）
7. **records → analysis_answers**: 1対多（1記録は複数の回答を持つ、任意）

#### CASCADE削除の設計思想

- ユーザーが削除された場合、そのユーザーに紐づく全データを削除（`ON DELETE CASCADE`）
- データの整合性を保つため、親エンティティの削除時に子エンティティも自動削除

---

## 5. API設計

### 5.1 APIエンドポイント一覧

#### 認証関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| POST | /api/auth/register | 不要 | ユーザー登録 | ✅ 実装済み |
| POST | /api/auth/login | 不要 | ログイン | ✅ 実装済み |
| GET | /api/auth/me | 必要 | 現在のユーザー情報取得 | ✅ 実装済み |

#### 記録関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/records | 必要 | 記録一覧取得 | ✅ 実装済み |
| GET | /api/records/:id | 必要 | 特定の記録取得 | ✅ 実装済み |
| POST | /api/records | 必要 | 記録作成（気象データ自動保存） | ✅ 実装済み |
| PUT | /api/records/:id | 必要 | 記録更新 | ✅ 実装済み |
| DELETE | /api/records/:id | 必要 | 記録削除 | ✅ 実装済み |
| GET | /api/records/stats | 必要 | 統計情報取得 | ✅ 実装済み |
| GET | /api/records/chart | 必要 | グラフデータ取得（時間単位集約） | ✅ 実装済み |

#### 分析関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/analysis/categories | 必要 | 分析観点一覧取得 | ✅ 実装済み |
| GET | /api/analysis/questions | 必要 | 質問一覧取得 | ✅ 実装済み |
| POST | /api/analysis/answers | 必要 | 回答保存 | ✅ 実装済み |
| GET | /api/analysis/generate-questions | 必要 | **AI質問生成** | ✅ **実装済み** |

#### 気象データ関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/weather/current | 必要 | 現在の気象データ取得 | ✅ 実装済み |
| GET | /api/weather/record/:recordId | 必要 | 記録に紐づく気象データ取得 | ❌ 未実装 |

---

### 5.2 主要APIリクエスト・レスポンス詳細

#### 5.2.1 ユーザー登録

**リクエスト**
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "message": "ユーザー登録が完了しました"
}
```

---

#### 5.2.2 記録作成

**リクエスト**
```http
POST /api/records
Authorization: Bearer {token}
Content-Type: application/json

{
  "sleep_hours": 7.5,
  "sleep_quality": 8,
  "meal_quality": 7,
  "meal_regularity": 8,
  "exercise_minutes": 30,
  "exercise_intensity": 6,
  "emotion_score": 8,
  "emotion_note": "今日は気分が良い",
  "motivation_score": 7,
  "activities_done": "プロジェクトのドキュメントを作成した"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "user_id": 1,
    "recorded_at": "2025-11-21T12:00:00.000Z",
    "sleep_hours": 7.5,
    "sleep_quality": 8,
    "meal_quality": 7,
    "meal_regularity": 8,
    "exercise_minutes": 30,
    "exercise_intensity": 6,
    "emotion_score": 8,
    "emotion_note": "今日は気分が良い",
    "motivation_score": 7,
    "activities_done": "プロジェクトのドキュメントを作成した",
    "created_at": "2025-11-21T12:00:00.000Z",
    "updated_at": "2025-11-21T12:00:00.000Z"
  },
  "message": "記録を作成しました"
}
```

**実装メモ**:
- レスポンス返却後、非同期で気象データを取得・保存
- 気象データ保存エラーは記録作成に影響しない

---

#### 5.2.3 AI質問生成 ✅ **新規実装**

**リクエスト**
```http
GET /api/analysis/generate-questions?categoryId=1
Authorization: Bearer {token}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": [
    {
      "id": 10,
      "category_id": 1,
      "question_text": "昨晩の睡眠中に夢を見ましたか？",
      "is_active": true,
      "generated_by_ai": true,
      "usage_count": 0,
      "created_at": "2025-11-21T10:00:00.000Z"
    },
    {
      "id": 11,
      "category_id": 1,
      "question_text": "起床時の疲労感はどの程度でしたか？",
      "is_active": true,
      "generated_by_ai": true,
      "usage_count": 0,
      "created_at": "2025-11-21T10:00:00.000Z"
    }
  ],
  "message": "AI質問を生成しました"
}
```

**処理フロー**:
1. カテゴリーIDで分析観点を取得
2. カテゴリー名と説明をコンテキストとして使用
3. Gemini APIで5つの質問を生成（JSON形式）
4. 生成された質問をDBに保存（`generated_by_ai = true`）
5. 保存された質問を返却

**エラーレスポンス例**:
```json
{
  "success": false,
  "message": "カテゴリーが見つかりませんでした"
}
```

---

#### 5.2.4 グラフデータ取得

**リクエスト**
```http
GET /api/records/chart
Authorization: Bearer {token}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "mood": [
      {
        "date": "2025-11-20 10:00",
        "avg_emotion": 7.5,
        "avg_motivation": 6.8
      },
      {
        "date": "2025-11-20 11:00",
        "avg_emotion": 8.0,
        "avg_motivation": 7.2
      }
    ],
    "weather": [
      {
        "date": "2025-11-20 10:00",
        "avg_temperature": 18.5,
        "avg_humidity": 65
      },
      {
        "date": "2025-11-20 11:00",
        "avg_temperature": 20.0,
        "avg_humidity": 60
      }
    ]
  }
}
```

**実装の特徴**:
- 時間単位でデータを集約（DATE_TRUNC関数使用）
- 横軸ラベル形式: MM/DD HH:00
- 平均値の自動計算
- 気温軸の動的範囲調整

---

### 5.3 エラーレスポンス形式

全てのAPIエラーは以下の形式で返却される。

```json
{
  "success": false,
  "message": "エラーメッセージ"
}
```

**HTTPステータスコード**:
- 200: 成功
- 201: 作成成功
- 400: バリデーションエラー
- 401: 認証エラー
- 404: リソースが見つからない
- 500: サーバーエラー

---

## 6. バックエンド構造

### 6.1 ディレクトリ構成

```
mood-tracker-api/
├── src/
│   ├── config/
│   │   └── database.ts           # DB接続設定
│   ├── controllers/
│   │   ├── authController.ts     # 認証コントローラー
│   │   ├── recordController.ts   # 記録コントローラー ✅ 気象データ自動保存実装済み
│   │   ├── analysisController.ts # 分析コントローラー ✅ AI質問生成実装済み
│   │   └── weatherController.ts  # 気象データコントローラー ✅ 現在の気象データ取得実装済み
│   ├── models/
│   │   ├── User.ts               # ユーザーモデル
│   │   ├── Record.ts             # 記録モデル
│   │   ├── Analysis.ts           # 分析モデル ✅ saveGeneratedQuestions 実装済み
│   │   └── WeatherData.ts        # 気象データモデル ✅ create, getByUserAndDate 実装済み
│   ├── routes/
│   │   ├── authRoutes.ts         # 認証ルート
│   │   ├── recordRoutes.ts       # 記録ルート
│   │   ├── analysisRoutes.ts     # 分析ルート ✅ /generate-questions 実装済み
│   │   └── weatherRoutes.ts      # 気象データルート ✅ /current 実装済み
│   ├── middleware/
│   │   ├── auth.ts               # 認証ミドルウェア
│   │   └── validation.ts         # バリデーションミドルウェア
│   ├── services/
│   │   ├── weatherService.ts     # 気象データサービス ✅ getCurrentWeather 実装済み
│   │   └── aiService.ts          # AIサービス ✅ generateQuestions 実装済み
│   ├── types/
│   │   └── index.ts              # TypeScript型定義
│   └── index.ts                  # エントリーポイント
├── .env                          # 環境変数
├── .env.example                  # 環境変数サンプル
├── package.json
└── tsconfig.json
```

### 6.2 主要コンポーネント

#### 6.2.1 AIサービス（aiService.ts） ✅ **実装済み**

**責務**:
- Gemini APIとの連携
- AI質問の生成
- データ分析（今後実装）
- アドバイス生成（今後実装）

**実装済み機能**:

**1. Gemini API接続設定**:
```typescript
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');
const model = genAI.getGenerativeModel({ model: 'gemini-pro' });
```

**2. AI質問生成関数**:
```typescript
export async function generateQuestions(
  categoryName: string,
  categoryDescription: string
): Promise<string[]> {
  try {
    const prompt = `あなたは心理カウンセラーです。以下の分析観点に基づいて、ユーザーの自己分析を助けるための質問を5つ生成してください。

分析観点: ${categoryName}
説明: ${categoryDescription}

要件:
- 質問は10段階評価で回答できる形式にしてください
- 質問は具体的で、ユーザーが答えやすいものにしてください
- 質問は日本語で生成してください
- 各質問は異なる視点から分析観点にアプローチしてください

出力形式: JSON配列
例: ["質問1", "質問2", "質問3", "質問4", "質問5"]

JSON配列のみを返却してください。他の説明文は不要です。`;

    const result = await model.generateContent(prompt);
    const response = result.response;
    const text = response.text();

    // JSONパース
    let jsonText = text.trim();
    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
    
    const questions = JSON.parse(jsonText);

    if (!Array.isArray(questions) || questions.length === 0) {
      throw new Error('Invalid response format from AI');
    }

    return questions;
  } catch (error) {
    console.error('AI question generation error:', error);
    throw new Error('AI質問の生成に失敗しました');
  }
}
```

**実装の特徴**:
- プロンプトエンジニアリング: 心理カウンセラーとしての役割設定
- コンテキスト提供: カテゴリー名と説明を含む
- 構造化されたレスポンス: JSON形式で5つの質問を生成
- エラーハンドリング: JSONパース失敗時の処理
- マークダウンコードブロックの除去

**今後実装予定の機能**:
```typescript
// データ分析機能（予定）
export async function analyzeData(
  userId: number,
  records: any[]
): Promise<AnalysisResult> {
  // 実装予定
}

// アドバイス生成機能（予定）
export async function generateAdvice(
  userId: number,
  analysisResult: AnalysisResult
): Promise<string> {
  // 実装予定
}
```

---

#### 6.2.2 分析モデル（Analysis.ts） ✅ **AI質問保存機能実装済み**

**実装済みメソッド**:

**1. AI生成質問の保存**:
```typescript
static async saveGeneratedQuestions(
  categoryId: number,
  questions: string[]
): Promise<AnalysisQuestion[]> {
  const savedQuestions: AnalysisQuestion[] = [];

  for (const questionText of questions) {
    const result = await pool.query(
      `INSERT INTO analysis_questions (category_id, question_text, generated_by_ai, is_active)
       VALUES ($1, $2, true, true)
       RETURNING *`,
      [categoryId, questionText]
    );

    savedQuestions.push({
      id: result.rows[0].id,
      category_id: result.rows[0].category_id,
      question_text: result.rows[0].question_text,
      is_active: result.rows[0].is_active,
      generated_by_ai: result.rows[0].generated_by_ai,
      usage_count: result.rows[0].usage_count,
      created_at: result.rows[0].created_at
    });
  }

  return savedQuestions;
}
```

**実装の特徴**:
- `generated_by_ai = true` でAI生成質問を識別
- `is_active = true` で有効な質問として保存
- トランザクション処理（今後改善予定）
- 全質問の保存結果を返却

**2. その他の実装済みメソッド**:
```typescript
// 分析観点一覧取得
static async getCategories(): Promise<AnalysisCategory[]>

// 有効な質問一覧取得
static async getActiveQuestions(categoryId?: number): Promise<AnalysisQuestion[]>

// 回答の保存
static async saveAnswers(userId: number, answers: AnalysisAnswerInput[]): Promise<void>
```

---

#### 6.2.3 分析コントローラー（analysisController.ts） ✅ **AI質問生成エンドポイント実装済み**

**実装済み機能**:

**1. AI質問生成エンドポイント**:
```typescript
export async function generateQuestions(req: Request, res: Response): Promise<void> {
  try {
    const categoryId = parseInt(req.query.categoryId as string);

    if (!categoryId) {
      res.status(400).json({
        success: false,
        message: 'カテゴリーIDが必要です'
      });
      return;
    }

    // カテゴリー情報を取得
    const categories = await AnalysisModel.getCategories();
    const category = categories.find(c => c.id === categoryId);

    if (!category) {
      res.status(404).json({
        success: false,
        message: 'カテゴリーが見つかりませんでした'
      });
      return;
    }

    // AI質問生成
    const questions = await aiService.generateQuestions(
      category.name,
      category.description || ''
    );

    // 質問をDBに保存
    const savedQuestions = await AnalysisModel.saveGeneratedQuestions(
      categoryId,
      questions
    );

    res.json({
      success: true,
      data: savedQuestions,
      message: 'AI質問を生成しました'
    });
  } catch (error) {
    console.error('AI question generation error:', error);
    res.status(500).json({
      success: false,
      message: 'AI質問の生成に失敗しました'
    });
  }
}
```

**処理フロー**:
1. クエリパラメータからカテゴリーIDを取得
2. カテゴリー情報を検証
3. aiService.generateQuestions() でAI質問を生成
4. AnalysisModel.saveGeneratedQuestions() で質問をDB保存
5. 保存された質問を返却

**エラーハンドリング**:
- カテゴリーID未指定: 400エラー
- カテゴリー未存在: 404エラー
- AI生成失敗: 500エラー

**2. その他の実装済みエンドポイント**:
```typescript
// 分析観点一覧取得
export async function getCategories(req: Request, res: Response): Promise<void>

// 質問一覧取得
export async function getQuestions(req: Request, res: Response): Promise<void>

// 回答保存
export async function saveAnswers(req: Request, res: Response): Promise<void>
```

---

#### 6.2.4 分析ルート（analysisRoutes.ts） ✅ **AI質問生成ルート実装済み**

**実装済みルート**:
```typescript
import { Router } from 'express';
import { authenticateToken } from '../middleware/auth';
import {
  getCategories,
  getQuestions,
  saveAnswers,
  generateQuestions  // ✅ 追加
} from '../controllers/analysisController';

const router = Router();

// 認証が必要
router.use(authenticateToken);

// 分析観点一覧取得
router.get('/categories', getCategories);

// 質問一覧取得
router.get('/questions', getQuestions);

// 回答保存
router.post('/answers', saveAnswers);

// AI質問生成 ✅ 新規追加
router.get('/generate-questions', generateQuestions);

export default router;
```

---

#### 6.2.5 記録コントローラー（recordController.ts） ✅ **気象データ自動保存実装済み**

**実装済み機能**:

**記録作成時の気象データ自動保存**:
```typescript
export async function createRecord(req: Request, res: Response): Promise<void> {
  try {
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ success: false, message: '認証が必要です' });
      return;
    }
    
    const recordData: RecordInput = req.body;
    const record = await RecordModel.create(userId, recordData);

    // 気象データを取得して保存（非同期で実行、エラーがあっても記録作成は成功とする）
    getCurrentWeather('Tokyo')
      .then(async (weatherData) => {
        if (weatherData) {
          await WeatherDataModel.create(
            userId,
            weatherData.temperature,
            weatherData.humidity,
            weatherData.weatherCondition,
            weatherData.location
          );
          console.log('Weather data saved successfully');
        }
      })
      .catch((error) => {
        console.error('Failed to save weather data:', error);
      });
    
    res.status(201).json({
      success: true,
      data: record,
      message: '記録を作成しました'
    });
  } catch (error) {
    console.error('記録作成エラー:', error);
    res.status(500).json({
      success: false,
      message: '記録の作成に失敗しました'
    });
  }
}
```

**実装の特徴**:
- 記録作成後、Promise の then/catch で気象データを非同期保存
- 気象API障害時も記録作成に影響しない設計
- 位置情報は 'Tokyo' で固定（今後の改善候補）

---

#### 6.2.6 気象データモデル（WeatherData.ts） ✅ **実装済み**

**実装済みメソッド**:

```typescript
export class WeatherDataModel {
  static async create(
    userId: number,
    temperature: number,
    humidity: number,
    weatherCondition: string,
    location?: string
  ): Promise<WeatherDataRow> {
    const result = await pool.query(
      `INSERT INTO weather_data (user_id, temperature, humidity, weather_condition, location, recorded_at)
       VALUES ($1, $2, $3, $4, $5, NOW())
       RETURNING *`,
      [userId, temperature, humidity, weatherCondition, location]
    );
    return result.rows[0];
  }

  static async getByUserAndDate(userId: number, date: Date): Promise<WeatherDataRow | null> {
    const result = await pool.query(
      `SELECT * FROM weather_data
       WHERE user_id = $1 AND DATE(recorded_at) = DATE($2)
       ORDER BY recorded_at DESC
       LIMIT 1`,
      [userId, date]
    );
    return result.rows[0] || null;
  }
}
```

---

#### 6.2.7 気象データサービス（weatherService.ts） ✅ **実装済み**

**実装済み機能**:

```typescript
export async function getCurrentWeather(city: string = 'Tokyo'): Promise<WeatherData | null> {
  try {
    if (!WEATHER_API_KEY) {
      console.error('Weather API key is not configured');
      return null;
    }

    const response = await axios.get<WeatherApiResponse>(`${WEATHER_API_URL}/current.json`, {
      params: {
        key: WEATHER_API_KEY,
        q: city,
        aqi: 'no'
      }
    });

    const data = response.data;

    return {
      temperature: data.current.temp_c,
      humidity: data.current.humidity,
      weatherCondition: data.current.condition.text,
      location: `${data.location.name}, ${data.location.country}`
    };
  } catch (error) {
    console.error('Weather API error:', error);
    return null;
  }
}
```

---

### 6.3 環境変数

**.env ファイル**:
```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=mood_tracker_db
DB_USER=postgres
DB_PASSWORD=your_password

# Server
PORT=3000

# JWT
JWT_SECRET=your_jwt_secret_key_here

# Weather API
WEATHER_API_KEY=your_weather_api_key
WEATHER_API_URL=https://api.weatherapi.com/v1

# Gemini API ✅ 追加
GEMINI_API_KEY=your_gemini_api_key
```

---

## 7. フロントエンド構造

### 7.1 ディレクトリ構成

```
mood-tracker-app/
├── src/
│   ├── components/
│   │   ├── Layout/
│   │   │   ├── Layout.tsx         # レイアウトコンポーネント
│   │   │   ├── Sidebar.tsx        # サイドバー
│   │   │   └── Layout.css
│   │   ├── Dashboard/
│   │   │   ├── Dashboard.tsx      # ダッシュボード
│   │   │   └── Dashboard.css
│   │   ├── charts/
│   │   │   ├── MoodChart.tsx      # 気分グラフ
│   │   │   └── WeatherChart.tsx   # 気象グラフ
│   │   ├── Record/
│   │   │   ├── RecordForm.tsx     # 記録入力フォーム ✅ 気象データカード表示実装済み
│   │   │   ├── RecordForm.css
│   │   │   ├── RecordList.tsx     # 記録一覧
│   │   │   ├── RecordList.css
│   │   │   ├── RecordDetail.tsx   # 記録詳細 ⚠️ 気象データ表示未完成
│   │   │   └── RecordDetail.css
│   │   ├── Analysis/
│   │   │   ├── AnalysisForm.tsx   # 自己分析画面 ✅ 実装済み
│   │   │   └── AnalysisForm.css
│   │   └── Auth/
│   │       ├── Login.tsx          # ログイン画面
│   │       ├── Register.tsx       # 登録画面
│   │       └── Auth.css
│   ├── services/
│   │   ├── api.ts                 # Axios設定
│   │   ├── authService.ts         # 認証サービス
│   │   ├── recordService.ts       # 記録サービス
│   │   ├── analysisService.ts     # 分析サービス ✅ 実装済み
│   │   └── weatherService.ts      # 気象データサービス ✅ getCurrentWeather 実装済み
│   ├── types/
│   │   └── index.ts               # TypeScript型定義
│   ├── App.tsx                    # ルートコンポーネント
│   ├── App.css
│   └── main.tsx                   # エントリーポイント
├── public/
├── index.html
├── package.json
├── tsconfig.json
└── vite.config.ts
```

### 7.2 主要コンポーネント

#### 7.2.1 ダッシュボード（Dashboard.tsx） ✅ **実装済み**

**表示内容**:
1. **グラフセクション**:
   - 気分とモチベーションの推移（MoodChart）
   - 気温と湿度の推移（WeatherChart）
   - 時間単位でのデータ集約
   - 動的な軸範囲調整

2. **統計パネル**:
   - 総記録数
   - 今週の記録数
   - 平均感情スコア
   - 平均モチベーション

3. **クイックアクション**:
   - 新しい記録の作成
   - 自己分析の実施

4. **最近の記録**:
   - 直近10件の記録表示
   - クリックで詳細画面へ遷移

---

#### 7.2.2 記録入力フォーム（RecordForm.tsx） ✅ **気象データ表示実装済み**

**入力項目**:
- 睡眠時間・睡眠の質
- 食事の質・食事の規則性
- 運動時間・運動強度
- 感情スコア・感情メモ
- モチベーション
- やったこと

**実装済み機能**:
- リアルタイムバリデーション
- **気象データの自動表示** ✅
  - weatherService.getCurrentWeather() を使用
  - 気象情報カードを表示（気温、湿度、天気、位置情報）
  - 天気アイコンの自動選択
- 送信時のローディング表示
- 成功・エラーメッセージの表示

**実装詳細**:
```typescript
const loadWeather = async () => {
  try {
    setWeatherLoading(true);
    const data = await getCurrentWeather();
    setWeather(data);
  } catch (error) {
    console.error('Weather load error:', error);
  } finally {
    setWeatherLoading(false);
  }
};

useEffect(() => {
  loadWeather();
}, []);
```

---

#### 7.2.3 記録詳細（RecordDetail.tsx） ⚠️ **気象データ表示未完成**

**表示内容**:
- 全ての記録データ
- スコアのバー形式表示
- 関連する気象データ（TODO状態）

**実装の問題点**:
```typescript
const loadWeather = async () => {
  try {
    setWeatherLoading(true);
    // TODO: 記録に紐づく天気情報を取得するように修正
    // const data = await getCurrentWeather();
    // setWeather(data);
    setWeather(null);
  } catch (error) {
    console.error('Weather load error:', error);
  } finally {
    setWeatherLoading(false);
  }
};
```

**問題の本質**:
- 現在は getCurrentWeather() を呼び出す実装（コメントアウト済み）
- 本来は記録に紐づく保存済み気象データを表示すべき
- weatherService に記録紐づき取得関数が未実装

---

#### 7.2.4 自己分析画面（AnalysisForm.tsx） ✅ **実装済み**

**機能**:
- 分析観点の選択
- 質問一覧の表示
- 10段階評価での回答入力
- 回答の保存

**実装状況**:
- バックエンドAPI連携実装済み
- 質問表示・回答保存機能実装済み
- AI質問生成ボタンは未実装（今後追加予定）

---

#### 7.2.5 グラフコンポーネント ✅ **実装済み**

**MoodChart.tsx**:
- Chart.jsを使用した折れ線グラフ
- 感情スコアとモチベーションの推移表示
- 時間単位でのデータ表示
- マウスホバー動作改善

**WeatherChart.tsx**:
- Chart.jsを使用した複合グラフ
- 気温（折れ線）と湿度（棒）の表示
- 時間単位でのデータ表示
- **気温軸の動的範囲調整機能** ✅
  - デフォルト：0度～40度
  - 0度を下回る場合：10の倍数に切り下げ
  - 40度を上回る場合：10の倍数に切り上げ
  - 範囲に応じた間隔の自動調整（2度/5度/10度）

---

### 7.3 サービス層

#### 7.3.1 分析サービス（analysisService.ts） ✅ **実装済み**

**実装済み関数**:
```typescript
// 分析観点一覧取得
export async function getCategories(): Promise<AnalysisCategory[]>

// 質問一覧取得
export async function getQuestions(categoryId?: number): Promise<AnalysisQuestion[]>

// 回答保存
export async function saveAnswers(answers: AnalysisAnswerInput[]): Promise<void>
```

**今後実装予定**:
```typescript
// AI質問生成（今後フロントエンド実装予定）
export async function generateQuestions(categoryId: number): Promise<AnalysisQuestion[]>
```

---

#### 7.3.2 気象データサービス（weatherService.ts）

**実装済み関数**:
```typescript
export async function getCurrentWeather(): Promise<CurrentWeather | null> {
  try {
    const response = await api.get<ApiResponse<CurrentWeather>>('/api/weather/current');
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    return null;
  } catch (error) {
    console.error('Weather fetch error:', error);
    return null;
  }
}
```

**未実装関数（TODOコメントあり）**:
```typescript
// TODO: 記録に紐づく天気情報を取得する関数を追加
```

---

### 7.4 型定義

**主要な型**:
- User: ユーザー情報
- Record: 記録データ
- RecordInput: 記録作成時の入力データ
- RecordStats: 統計情報
- ChartData: グラフデータ
- AnalysisCategory: 分析観点 ✅
- AnalysisQuestion: 質問データ ✅
- AnalysisAnswer: 回答データ ✅
- ApiResponse: APIレスポンスのラッパー型
- CurrentWeather: 現在の気象データ

---

## 8. 認証・認可

### 8.1 認証フロー

#### ユーザー登録フロー

```
1. ユーザーが登録フォームに情報入力
   ↓
2. フロントエンドが /api/auth/register にPOST
   ↓
3. バックエンドがユーザー名・メールの重複チェック
   ↓
4. パスワードをbcryptでハッシュ化
   ↓
5. DBにユーザー情報を保存
   ↓
6. JWTトークンを生成
   ↓
7. ユーザー情報とトークンを返却
   ↓
8. フロントエンドがトークンをlocalStorageに保存
   ↓
9. 自動的にダッシュボードに遷移
```

### 8.2 JWT（JSON Web Token）

#### トークンの構成

```
Header.Payload.Signature
```

**Payload（ペイロード）**:
```json
{
  "userId": 1,
  "username": "testuser",
  "iat": 1699000000,
  "exp": 1699604800
}
```

**有効期限**: 7日間

### 8.3 セキュリティ対策

#### パスワード管理
- **ハッシュ化**: bcryptを使用（ソルトラウンド: 10）
- **平文保存禁止**: データベースにはハッシュ値のみ保存
- **最小文字数**: 6文字以上

#### トークン管理
- **保存場所**: localStorage
- **自動削除**: ログアウト時、トークン期限切れ時
- **HTTPS推奨**: 本番環境では必須

#### API保護
- **認証必須**: ほとんどのエンドポイントで認証が必要
- **CORS設定**: 許可されたオリジンのみアクセス可能

---

## 9. 外部API連携

### 9.1 WeatherAPI ✅ **実装済み**

#### 概要
気象データを取得するための無料API。

**公式サイト**: https://www.weatherapi.com/

#### 使用方法

**エンドポイント**:
```
GET https://api.weatherapi.com/v1/current.json
```

**パラメータ**:
- `key`: APIキー
- `q`: 都市名（例: Tokyo）
- `aqi`: 大気質情報（no）

#### データの保存タイミング ✅

記録作成時に自動的に気象データを取得・保存。

**処理フロー**:
1. ユーザーが記録を作成
2. RecordModel.create()が記録をDBに保存
3. レスポンスを返却
4. 非同期で getCurrentWeather('Tokyo') を呼び出し
5. 取得した気象データを weather_data テーブルに保存
6. エラーが発生しても記録作成には影響しない

---

### 9.2 Google Gemini API ✅ **部分実装（質問生成完了）**

#### 概要
AIによるデータ分析とアドバイス生成に使用。

**公式サイト**: https://ai.google.dev/

#### 実装済み機能

**1. AI質問生成** ✅:
- ユーザーのデータ傾向から不足している分析観点を特定
- 適切な質問を自動生成（5つ/カテゴリー）
- 10段階評価で回答できる形式

**実装詳細**:
- モデル: gemini-pro
- プロンプト: 心理カウンセラーとしての役割設定
- コンテキスト: カテゴリー名と説明
- 出力形式: JSON配列
- エラーハンドリング: JSONパース失敗時の処理

#### 今後実装予定の機能

**2. データ分析**:
- 過去のデータから傾向を抽出
- 調子の良い日・悪い日のパターン分析
- 気象データとの相関分析

**3. アドバイス生成**:
- 現在の状態に基づくアドバイス
- 気象予報を考慮した行動提案
- 長期的な改善提案

---

## 10. データフロー

### 10.1 記録作成フロー ✅ **気象データ自動保存実装済み**

```
┌──────────────┐
│ユーザー      │
│記録入力      │
└──────┬───────┘
       │
       │ 1. フォーム送信
       ↓
┌──────────────┐
│RecordForm    │
│(フロント)    │
│気象データ表示│ ✅ 実装済み
└──────┬───────┘
       │
       │ 2. POST /api/records
       ↓
┌──────────────┐
│recordService │
│(API呼び出し) │
└──────┬───────┘
       │
       │ 3. HTTPリクエスト
       ↓
┌──────────────┐
│Express Server│
│認証MW→検証MW │
└──────┬───────┘
       │
       │ 4. コントローラー呼び出し
       ↓
┌──────────────┐
│recordController│
│.createRecord()│
└──────┬───────┘
       │
       │ 5. モデル呼び出し
       ↓
┌──────────────┐
│RecordModel   │
│.create()     │
└──────┬───────┘
       │
       │ 6. INSERT文実行
       ↓
┌──────────────┐
│PostgreSQL    │
│records表     │
└──────┬───────┘
       │
       │ 7. 保存完了・レスポンス返却
       │
       ├────────────────────┐
       │                    │
       ↓                    │
┌──────────────┐            │
│フロントエンド│            │
│成功メッセージ│            │
└──────────────┘            │
                            │
       ┌────────────────────┘
       │
       │ 8. 非同期で気象データ取得 ✅
       ↓
┌──────────────┐
│weatherService│
│.getCurrentWeather('Tokyo')│
└──────┬───────┘
       │
       │ 9. WeatherAPI呼び出し
       ↓
┌──────────────┐
│WeatherAPI    │
└──────┬───────┘
       │
       │ 10. 気象データ取得
       ↓
┌──────────────┐
│WeatherDataModel│
│.create()     │
└──────┬───────┘
       │
       │ 11. INSERT文実行
       ↓
┌──────────────┐
│PostgreSQL    │
│weather_data表│
└──────┬───────┘
       │
       │ 12. 保存完了（エラーでも記録作成には影響なし）
       ↓
    完了
```

---

### 10.2 AI質問生成フロー ✅ **実装済み**

```
┌──────────────┐
│ユーザー      │
│AI質問生成    │
│ボタンクリック│
└──────┬───────┘
       │
       │ 1. 質問生成リクエスト
       ↓
┌──────────────┐
│AnalysisForm  │
│(フロント)    │
│今後実装予定  │
└──────┬───────┘
       │
       │ 2. GET /api/analysis/generate-questions?categoryId=1
       ↓
┌──────────────┐
│analysisService│
│(API呼び出し) │
│今後実装予定  │
└──────┬───────┘
       │
       │ 3. HTTPリクエスト
       ↓
┌──────────────┐
│Express Server│
│認証MW        │
└──────┬───────┘
       │
       │ 4. コントローラー呼び出し
       ↓
┌──────────────────┐
│analysisController│
│.generateQuestions()│ ✅ 実装済み
└──────┬─────────────┘
       │
       │ 5. カテゴリー情報取得
       ↓
┌──────────────┐
│AnalysisModel │
│.getCategories()│
└──────┬───────┘
       │
       │ 6. カテゴリー検証
       ↓
┌──────────────┐
│aiService     │
│.generateQuestions()│ ✅ 実装済み
└──────┬───────┘
       │
       │ 7. プロンプト生成
       │    コンテキスト: カテゴリー名・説明
       ↓
┌──────────────┐
│Gemini API    │
│gemini-pro    │
└──────┬───────┘
       │
       │ 8. AI質問生成（JSON形式、5つ）
       ↓
┌──────────────┐
│aiService     │
│JSONパース    │
└──────┬───────┘
       │
       │ 9. 生成された質問
       ↓
┌──────────────────┐
│AnalysisModel     │
│.saveGeneratedQuestions()│ ✅ 実装済み
└──────┬─────────────┘
       │
       │ 10. INSERT文実行（generated_by_ai=true）
       ↓
┌──────────────┐
│PostgreSQL    │
│analysis_     │
│questions表   │
└──────┬───────┘
       │
       │ 11. 保存された質問を返却
       ↓
┌──────────────┐
│フロントエンド│
│質問一覧表示  │
│今後実装予定  │
└──────────────┘
```

**実装の特徴**:
- カテゴリー情報をコンテキストとして使用
- Gemini API で構造化されたレスポンスを取得（JSON形式）
- 生成された質問をDBに保存（`generated_by_ai = true`）
- エラーハンドリング実装済み

---

### 10.3 ダッシュボード表示フロー ✅ **実装済み**

```
┌──────────────┐
│ユーザー      │
│ダッシュボード│
│アクセス      │
└──────┬───────┘
       │
       │ 1. ページ表示
       ↓
┌──────────────┐
│Dashboard     │
│(フロント)    │
└──────┬───────┘
       │
       │ 2. データ取得開始
       │
       ├──────────┬──────────┐
       │          │          │
       ↓          ↓          ↓
  統計データ   グラフデータ  記録一覧
  GET /stats  GET /chart   GET /records
       │          │          │
       ↓          ↓          ↓
┌──────────────┐ ┌──────────┐ ┌──────────┐
│RecordModel   │ │RecordModel│ │RecordModel│
│.getStats()   │ │.getChart..│ │.findBy...│
└──────┬───────┘ └─────┬────┘ └─────┬────┘
       │               │            │
       │               │            │
       └───────────────┴────────────┘
                       │
                       │ 3. データ集約
                       ↓
               ┌──────────────┐
               │PostgreSQL    │
               │複数テーブル  │
               │結合クエリ    │
               │時間単位集約  │ ✅ 実装済み
               └──────┬───────┘
                      │
                      │ 4. レスポンス返却
                      ↓
               ┌──────────────┐
               │Dashboard     │
               │データ表示    │
               │グラフ描画    │
               │動的範囲調整  │ ✅ 実装済み
               └──────────────┘
```

---

## 11. 主要機能詳細

### 11.1 記録入力機能 ✅ **実装済み**

#### 機能概要
ユーザーが日々の調子を記録するためのフォーム機能。

#### 入力項目
1. **睡眠**: 睡眠時間、睡眠の質（1～10段階）
2. **食事**: 食事の質、食事の規則性（1～10段階）
3. **運動**: 運動時間、運動強度（1～10段階）
4. **感情**: 感情スコア、感情メモ（1～10段階、自由記述）
5. **モチベーション**: モチベーションスコア（1～10段階）
6. **活動内容**: やったこと（自由記述）

#### 自動処理
- 記録時刻の自動設定
- **気象データの自動取得・保存** ✅
- データベースへの保存

#### 気象データ表示 ✅
- 記録作成時に現在の気象データを表示
- 気象情報カード（気温、湿度、天気、位置情報）
- 天気アイコンの自動選択

---

### 11.2 自己分析機能 ✅ **実装済み**

#### 質問表示 ✅
- 分析観点ごとの質問を表示
- 10段階評価での回答
- AI生成の質問も表示可能

#### 回答保存 ✅
- 記録と紐づけて保存
- 記録とは独立した回答も可能

#### AI質問生成 ✅ **バックエンド実装済み**
- **Gemini API による動的な質問生成**
- 分析観点に基づいて5つの質問を生成
- 10段階評価で回答できる形式
- `generated_by_ai = true` でDB保存

**実装状況**:
- バックエンド: ✅ 完全実装
- フロントエンド: ⚠️ 今後実装予定（質問生成ボタンとUI）

---

### 11.3 ダッシュボード機能 ✅ **実装済み**

#### 表示コンテンツ

**1. グラフセクション** ✅:
- 気分とモチベーションの推移
- 気温と湿度の推移
- 時間単位でのデータ集約
- 動的な軸範囲調整

**2. 統計パネル** ✅:
- 総記録数
- 今週の記録数
- 平均感情スコア
- 平均モチベーション

**3. クイックアクション** ✅:
- 新規記録作成ボタン
- 自己分析実施ボタン

**4. 最近の記録** ✅:
- 直近10件の記録をカード形式で表示
- クリックで詳細画面に遷移

---

### 11.4 記録詳細機能 ⚠️ **気象データ表示未完成**

#### 表示内容
- 全ての記録データ
- スコアをバー形式で視覚化
- **関連する気象データの表示（TODO状態）**

#### 課題
- 現在は getCurrentWeather() を呼び出す実装（コメントアウト済み）
- 本来は記録に紐づく保存済み気象データを表示すべき
- weatherService に記録紐づき取得関数が未実装
- バックエンドに該当APIエンドポイントが未実装

---

### 11.5 気象データ連携機能 ✅ **実装済み**

#### 自動取得
- 記録作成時に自動実行
- WeatherAPIからデータ取得
- 非同期処理で実行

#### 保存データ
- 気温、湿度
- 天気の状態
- 位置情報（'Tokyo'固定）

#### データ活用
- グラフでの可視化 ✅
- 記録との相関分析（今後実装）
- アドバイス生成時の考慮要素（今後実装）

---

## 12. 実装状況と課題

### 12.1 実装完了機能

#### Phase 1: 環境構築と基礎知識 ✅ **完了**
1. ✅ 開発環境構築
2. ✅ React基礎
3. ✅ Node.js + Express基礎

#### Phase 2: 基本機能実装 ✅ **完了**
1. ✅ データベース設計
2. ✅ バックエンドAPI実装
3. ✅ フロントエンドとバックエンドの連携
4. ✅ バリデーション実装

#### Phase 3: 主要機能実装 ✅ **完了**
1. ✅ 記録入力画面の実装（気象データ表示含む）
2. ✅ 自己分析機能（質問表示・回答保存）
3. ✅ ダッシュボード基礎（レイアウト・統計パネル）
4. ✅ データ可視化（グラフ表示、時間単位集約、動的範囲調整）
5. ✅ 気象データ連携（自動取得・保存・表示）

#### Phase 4: AI機能統合 🔄 **進行中（2/4ステップ完了）**
1. ✅ Gemini API基礎
2. ✅ **AI質問生成機能**
   - aiService.ts の実装
   - generateQuestions 関数
   - Analysis.saveGeneratedQuestions 関数
   - /api/analysis/generate-questions エンドポイント
   - プロンプトエンジニアリング
   - JSON形式でのレスポンス取得
3. ❌ データ分析機能（未実装）
4. ❌ アドバイス生成機能（未実装）

---

### 12.2 実装課題

#### 最優先課題

**1. 記録詳細画面の気象データ表示機能の完成**

**必要な実装**:

**バックエンド**:
- `GET /api/weather/record/:recordId` エンドポイントの実装
- weatherController に getWeatherByRecordId() 関数を追加

**フロントエンド**:
- weatherService に getWeatherByRecordId() 関数を追加
- RecordDetail.tsx の loadWeather() を実装完成

**実装時間目安**: 30～45分

---

#### その他の課題

**2. AI質問生成機能のフロントエンド実装**
- AnalysisForm に質問生成ボタンを追加
- analysisService に generateQuestions() を追加
- 生成された質問の表示

**3. 位置情報の動的取得**
- 現在は 'Tokyo' 固定
- ブラウザのGeolocation APIを使用
- ユーザー設定による位置情報管理

**4. データ分析機能の実装**
- Gemini API を活用したデータ傾向分析
- 気象データとの相関分析
- 調子の良い日・悪い日のパターン抽出

**5. アドバイス生成機能の実装**
- Gemini API連携
- パーソナライズされたアドバイス生成
- ダッシュボードへのアドバイス表示

**6. 記録編集機能の追加**
- 編集画面実装
- 更新API完成

---

### 12.3 今後の拡張予定

#### 短期的な実装予定
1. 記録詳細画面の気象データ表示機能を完成させる（最優先）
2. AI質問生成機能のフロントエンド実装
3. データ分析機能の実装
4. アドバイス機能の実装
5. 記録の編集機能

#### 中期的な実装予定
1. 通知機能
2. グラフの強化
3. レポート機能
4. 目標設定機能

#### 長期的な実装予定
1. ソーシャル機能
2. ウェアラブルデバイス連携
3. AI精度向上
4. 多言語対応

---

## 13. 開発ロードマップ

### 13.1 進捗状況

**総学習時間**: 約945分（約15.75時間）  
**総ステップ数**: 21ステップ

**現在の進捗率**: 14/21ステップ = **約67%完了**

**完了状況**:
- ✅ Phase 1 完了（3/3ステップ） - 2025年11月上旬
- ✅ Phase 2 完了（4/4ステップ） - 2025年11月7日～13日
- ✅ Phase 3 完了（5/5ステップ） - 2025年11月13日～14日
- 🔄 Phase 4 進行中（2/4ステップ） - 2025年11月21日
  - ✅ ステップ4-1: Gemini API基礎
  - ✅ ステップ4-2: AI質問生成機能
  - ❌ ステップ4-3: データ分析機能
  - ❌ ステップ4-4: アドバイス生成機能
- ❌ Phase 5（0/3ステップ）
- ❌ Phase 6（0/2ステップ）

**次のマイルストーン**: Phase 4ステップ4-3（データ分析機能）

---

### 13.2 実装済みの追加機能

ロードマップ以外に実装された機能：

**記録詳細画面**:
- RecordDetail.tsx / RecordDetail.css
- 記録の全データ表示
- スコアのバー形式表示
- 気象情報カードの表示（TODO状態）
- 一覧へ戻る機能

**記録一覧画面**:
- RecordList.tsx / RecordList.css
- カード形式での記録一覧表示
- 詳細画面への遷移

**グラフ表示の高度な機能**:
- 時間単位でのデータ集約（DATE_TRUNC関数）
- 平均値の自動計算
- 横軸ラベルの形式統一（MM/DD HH:00）
- マウスホバー動作の改善（mode: 'index', intersect: false）
- 気温軸の動的範囲調整機能
  - デフォルト：0度～40度
  - 0度を下回る場合：10の倍数に切り下げ
  - 40度を上回る場合：10の倍数に切り上げ
  - 範囲に応じた間隔の自動調整（2度/5度/10度）

---

### 13.3 習得済みスキル

#### フロントエンド ✅ 習得済み（基礎～応用）
- ✅ React 18の基本から応用まで
- ✅ TypeScriptによる型安全な開発
- ✅ コンポーネント設計とState管理
- ✅ フック（useState, useEffect、カスタムフック）の活用
- ✅ フォーム処理とバリデーション
- ✅ データ可視化（Chart.js、時間単位集約、動的範囲調整）
- ✅ レスポンシブデザイン

#### バックエンド ✅ 習得済み（基礎～応用）
- ✅ Node.js + Expressによるサーバー構築
- ✅ RESTful API設計と実装
- ✅ PostgreSQLによるデータベース操作
- ✅ 環境変数とセキュリティ
- ✅ エラーハンドリング
- ✅ 外部API連携（WeatherAPI）

#### AI統合 🔄 習得中（基礎～中級）
- ✅ LLM API（Gemini）の基礎
- ✅ プロンプトエンジニアリングの基礎
- ✅ 構造化されたレスポンス取得（JSON）
- ✅ AIによる質問生成
- ✅ コンテキストを含むプロンプト設計
- ❌ AIを活用したデータ分析（未習得）
- ❌ パーソナライズ機能の実装（未習得）

#### テストとCI/CD ❌ 未習得
- ❌ ユニットテストの作成
- ❌ E2Eテストの設計と実装
- ❌ GitHub Actionsによる自動化
- ❌ 継続的インテグレーション/デプロイメント

#### デプロイ ❌ 未習得
- ❌ 無償ホスティングサービスの活用
- ❌ 本番環境の設定
- ❌ トラブルシューティング

---

## 14. まとめ

本システムは、React + TypeScript のフロントエンドと Node.js + Express + PostgreSQL のバックエンドで構成される、AIを活用した調子記録Webアプリケーションである。

**主要な特徴**:
- JWT認証による安全なユーザー管理
- RESTful APIによる明確な責任分離
- PostgreSQLによる堅牢なデータ管理
- Chart.jsによる直感的なデータ可視化
- 外部APIとの連携（気象データ、AI質問生成）
- スケーラブルなアーキテクチャ設計
- **AI質問生成機能** ✅ 実装済み
- **気象データの自動取得・保存機能** ✅ 実装済み

**技術的な強み**:
- TypeScriptによる型安全性
- MVCパターンによる保守性の高い設計
- 非同期処理による高いパフォーマンス
- レスポンシブデザインによるマルチデバイス対応
- プロンプトエンジニアリングによるAI活用

**現在の実装状況**:
- ほとんどの主要機能は実装完了（約67%）
- AI質問生成機能が新たに実装完了
- 気象データの自動保存は正常に動作
- 記録詳細画面の気象データ表示が未完成（最優先課題）

**次の実装ステップ**:
1. 記録詳細画面の気象データ表示機能を完成させる（最優先）
2. AI質問生成機能のフロントエンド実装
3. データ分析機能の実装（Phase 4ステップ4-3）
4. アドバイス生成機能の実装（Phase 4ステップ4-4）

本定義書は、システムの全体像を理解し、今後の開発や保守を円滑に進めるための基礎資料として活用されることを想定している。

---

**文書バージョン**: 3.0  
**作成日**: 2025年11月7日  
**最終更新日**: 2025年11月21日  
**更新内容**: AI質問生成機能の実装詳細を追加、Phase 4進捗状況を更新（2/4ステップ完了）、進捗率を67%に更新
