# 調子記録アプリ システム設計定義書

## 目次

1. [システム概要](#1-システム概要)
2. [技術スタック](#2-技術スタック)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [データベース設計](#4-データベース設計)
5. [API設計](#5-api設計)
6. [バックエンド構造](#6-バックエンド構造)
7. [フロントエンド構造](#7-フロントエンド構造)
8. [認証・認可](#8-認証認可)
9. [外部API連携](#9-外部api連携)
10. [データフロー](#10-データフロー)
11. [主要機能詳細](#11-主要機能詳細)
12. [テストとCI/CD](#12-テストとcicd)
13. [デプロイメント](#13-デプロイメント)
14. [実装状況](#14-実装状況)

---

## 1. システム概要

### 1.1 アプリケーション名
**Mood Tracker - AIを活用した調子記録アプリ**

### 1.2 目的
ユーザーが日々の調子を記録し、AIによる分析とアドバイスを受けることで、自己理解を深め、より良い生活習慣を構築することを支援するWebアプリケーション。

### 1.3 主要機能
- ユーザー認証（登録・ログイン）
- 調子データの記録（体調、気分、活動内容など）
- 自己分析質問への回答（10段階評価）
- **AI質問生成機能（分析観点に基づく動的な質問生成）** ✅ **実装済み**
- **AIデータ分析機能（傾向分析と相関分析）** ✅ **実装済み**
- **パーソナライズアドバイス生成機能** ✅ **実装済み**
- 気象データの自動取得・記録
- ダッシュボードでのデータ可視化（グラフ表示）
- 記録の一覧表示・詳細表示

### 1.4 ターゲットユーザー
自己管理を行いたい個人ユーザー

### 1.5 開発環境
- **OS**: Windows 11 24H2
- **エディタ**: VSCode
- **プロジェクトパス**: E:\ReactProject\
- **無償ツールのみ使用**

### 1.6 本番環境
- **フロントエンド**: Vercel
- **バックエンド**: Render.com
- **データベース**: Supabase (PostgreSQL)
- **稼働状況**: ✅ 運用中

---

## 2. 技術スタック

### 2.1 フロントエンド
| 技術 | バージョン | 用途 | 実装状況 |
|------|-----------|------|---------|
| React | 18.x | UIライブラリ | ✅ 実装済み |
| TypeScript | 5.x | 型安全な開発 | ✅ 実装済み |
| Vite | 5.x | ビルドツール・開発サーバー | ✅ 実装済み |
| Axios | 1.x | HTTP通信 | ✅ 実装済み |
| Chart.js | 4.x | データ可視化 | ✅ 実装済み |
| React Icons | 5.x | アイコン表示 | ✅ 実装済み |
| Vitest | 最新 | ユニットテスト | ✅ 実装済み |
| Playwright | 最新 | E2Eテスト | ✅ 実装済み |

### 2.2 バックエンド
| 技術 | バージョン | 用途 | 実装状況 |
|------|-----------|------|---------|
| Node.js | 20.x LTS | ランタイム環境 | ✅ 実装済み |
| Express | 4.x | Webフレームワーク | ✅ 実装済み |
| TypeScript | 5.x | 型安全な開発 | ✅ 実装済み |
| pg (node-postgres) | 8.x | PostgreSQLクライアント | ✅ 実装済み |
| bcryptjs | 2.x | パスワードハッシュ化 | ✅ 実装済み |
| jsonwebtoken | 9.x | JWT認証 | ✅ 実装済み |
| express-validator | 7.x | バリデーション | ✅ 実装済み |
| dotenv | 16.x | 環境変数管理 | ✅ 実装済み |
| @google/generative-ai | 最新 | Gemini API連携 | ✅ 実装済み |
| Jest | 最新 | ユニットテスト | ✅ 実装済み |

### 2.3 データベース
| 技術 | バージョン | 用途 | 実装状況 |
|------|-----------|------|---------|
| PostgreSQL | 15.x | リレーショナルデータベース | ✅ 実装済み（Supabase） |

### 2.4 外部API
| サービス | 用途 | 実装状況 |
|---------|------|---------|
| Google Gemini API | AI分析・質問生成・アドバイス生成 | ✅ 完全実装 |
| WeatherAPI | 気象データ取得 | ✅ 実装済み |

### 2.5 開発ツール
| ツール | 用途 | 実装状況 |
|--------|------|---------|
| VSCode | エディタ | ✅ 使用中 |
| Git | バージョン管理 | ✅ 使用中 |
| npm | パッケージ管理 | ✅ 使用中 |
| GitHub Actions | CI/CD | ✅ 実装済み |

### 2.6 デプロイメント
| サービス | 用途 | 実装状況 |
|---------|------|---------|
| Vercel | フロントエンドホスティング | ✅ デプロイ済み |
| Render.com | バックエンドホスティング | ✅ デプロイ済み |
| Supabase | PostgreSQLホスティング | ✅ 運用中 |

---

## 3. システムアーキテクチャ

### 3.1 全体構成

```
┌─────────────────┐
│   ブラウザ      │
│   (React)       │
└────────┬────────┘
         │ HTTPS
         │ (REST API)
         │
    ┌────┴────┐
    │ Vercel  │ (フロントエンド)
    └────┬────┘
         │
         │ HTTPS API呼び出し
         ↓
    ┌────────────┐
    │ Render.com │ (バックエンド)
    │  Express   │
    └────┬───────┘
         │
    ┌────┴────┬────────────┬────────────┐
    │         │            │            │
┌───┴────┐ ┌──┴──────┐ ┌──┴─────────┐ │
│Supabase│ │Gemini API│ │WeatherAPI│ │
│PostgreSQL│ │         │ │          │ │
└─────────┘ └─────────┘ └──────────┘ │
  ✅ 運用中   ✅ 実装済み   ✅ 実装済み │
```

### 3.2 アーキテクチャパターン
- **フロントエンド**: コンポーネントベースアーキテクチャ
- **バックエンド**: MVC（Model-View-Controller）パターン
- **通信**: RESTful API
- **認証**: JWT（JSON Web Token）ベース
- **デプロイ**: サーバーレス/コンテナベース

### 3.3 レイヤー構成

#### フロントエンド
```
Presentation Layer (Components)
        ↓
Service Layer (API Clients)
        ↓
HTTP Client (Axios)
```

#### バックエンド
```
Route Layer (ルーティング)
        ↓
Controller Layer (ビジネスロジック)
        ↓
Model Layer (データアクセス)
        ↓
Database (PostgreSQL)
```

---

## 4. データベース設計

### 4.1 ER図

```
┌──────────────┐
│    users     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────┴───────┐
│   records    │
└──────────────┘
       │ 1
       ├─────────────────────┐
       │                     │
       │ N                   │ N
┌──────┴──────────┐  ┌──────┴─────────┐
│analysis_answers │  │  weather_data  │
└─────────────────┘  └────────────────┘
       │ N
       │
       │ 1
┌──────┴──────────────┐
│analysis_questions   │ ✅ AI生成質問対応
└─────────────────────┘
       │ N
       │
       │ 1
┌──────┴──────────────┐
│analysis_categories  │
└─────────────────────┘

┌──────────────┐
│    users     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────┴───────────┐
│advice_history    │ ✅ 実装済み
└──────────────────┘
```

### 4.2 テーブル定義

#### 4.2.1 users（ユーザー情報）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | ユーザーID（自動採番） |
| username | VARCHAR(50) | UNIQUE NOT NULL | ユーザー名 |
| email | VARCHAR(255) | UNIQUE NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ値 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**: なし（PRIMARY KEYとUNIQUE制約により自動作成）

---

#### 4.2.2 records（記録データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 記録ID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| recorded_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 記録日時 |
| sleep_hours | DECIMAL(3,1) | NULL | 睡眠時間（時間） |
| sleep_quality | INTEGER | CHECK (1～10), NULL | 睡眠の質（10段階） |
| meal_quality | INTEGER | CHECK (1～10), NULL | 食事の質（10段階） |
| meal_regularity | INTEGER | CHECK (1～10), NULL | 食事の規則性（10段階） |
| exercise_minutes | INTEGER | NULL | 運動時間（分） |
| exercise_intensity | INTEGER | CHECK (1～10), NULL | 運動強度（10段階） |
| emotion_score | INTEGER | CHECK (1～10), NULL | 感情スコア（10段階） |
| emotion_note | TEXT | NULL | 感情に関するメモ |
| motivation_score | INTEGER | CHECK (1～10), NULL | モチベーション（10段階） |
| activities_done | TEXT | NULL | やったこと（自由記述） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_records_user_id` ON (user_id)
- `idx_records_recorded_at` ON (recorded_at)

---

#### 4.2.3 analysis_categories（分析観点マスタ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 観点ID（自動採番） |
| code | VARCHAR(50) | UNIQUE NOT NULL | 観点コード |
| name | VARCHAR(100) | NOT NULL | 観点名称 |
| description | TEXT | NULL | 説明 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**初期データ**:
- ストレス、集中力、モチベーション、睡眠の質、社会的つながり

---

#### 4.2.4 analysis_questions（質問マスタ） ✅ **AI生成対応**

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 質問ID（自動採番） |
| category_id | INTEGER | NOT NULL, REFERENCES analysis_categories(id) ON DELETE CASCADE | 分析観点ID |
| question_text | TEXT | NOT NULL | 質問文 |
| is_active | BOOLEAN | DEFAULT true | 有効フラグ |
| generated_by_ai | BOOLEAN | DEFAULT false | **AI生成フラグ** ✅ |
| usage_count | INTEGER | DEFAULT 0 | 使用回数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
- `idx_questions_category_id` ON (category_id)
- `idx_questions_is_active` ON (is_active)

**AI生成質問の実装** ✅:
- `generated_by_ai = true` で保存
- Claude API により分析観点に基づいて動的に生成
- 各カテゴリーにつき5つの質問を生成可能

---

#### 4.2.5 analysis_answers（回答データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 回答ID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| record_id | INTEGER | REFERENCES records(id) ON DELETE CASCADE, NULL | 記録ID（任意） |
| question_id | INTEGER | NOT NULL, REFERENCES analysis_questions(id) ON DELETE CASCADE | 質問ID |
| answer_score | INTEGER | NOT NULL, CHECK (1～10) | 回答スコア（10段階） |
| answered_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 回答日時 |

**インデックス**:
- `idx_answers_user_id` ON (user_id)
- `idx_answers_record_id` ON (record_id)
- `idx_answers_question_id` ON (question_id)
- `idx_answers_answered_at` ON (answered_at)

---

#### 4.2.6 weather_data（気象データ）

| カラム名 | データ型 | 制約 | 説明 | 実装状況 |
|---------|---------|------|------|---------|
| id | SERIAL | PRIMARY KEY | 気象データID（自動採番） | ✅ 実装済み |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID | ✅ 実装済み |
| recorded_at | TIMESTAMP | NOT NULL | 記録日時 | ✅ 実装済み |
| temperature | DECIMAL(4,1) | NULL | 気温（℃） | ✅ 実装済み |
| humidity | INTEGER | NULL | 湿度（%） | ✅ 実装済み |
| pressure | DECIMAL(6,2) | NULL | 気圧（hPa） | ⚠️ 未使用 |
| weather_condition | VARCHAR(100) | NULL | 天気の状態 | ✅ 実装済み |
| weather_description | TEXT | NULL | 詳細な天気説明 | ⚠️ 未使用 |
| season | VARCHAR(20) | NULL | 季節 | ⚠️ 未使用 |
| location | VARCHAR(255) | NULL | 位置情報 | ✅ 実装済み（'Tokyo'固定） |
| api_source | VARCHAR(50) | NULL | データ取得元API | ⚠️ 未使用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 | ✅ 実装済み |

**インデックス**:
- `idx_weather_user_id` ON (user_id)
- `idx_weather_recorded_at` ON (recorded_at)

**実装メモ**:
- 実際に保存されるデータ: user_id, temperature, humidity, weather_condition, location, recorded_at
- pressure, weather_description, season, api_source は現在未使用
- location は 'Tokyo' で固定（今後の改善候補）

---

#### 4.2.7 advice_history（アドバイス履歴） ✅ **実装済み**

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | アドバイスID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| advice_text | TEXT | NOT NULL | アドバイス本文 |
| advice_type | VARCHAR(50) | NULL | アドバイスの種類 |
| based_on_data | JSONB | NULL | 生成に使用したデータ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| displayed_at | TIMESTAMP | NULL | 表示日時 |
| was_helpful | BOOLEAN | NULL | 役立ったかのフィードバック |

**インデックス**:
- `idx_advice_user_id` ON (user_id)
- `idx_advice_created_at` ON (created_at)

---

## 5. API設計

### 5.1 APIエンドポイント一覧

#### 認証関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| POST | /api/auth/register | 不要 | ユーザー登録 | ✅ 実装済み |
| POST | /api/auth/login | 不要 | ログイン | ✅ 実装済み |
| GET | /api/auth/me | 必要 | 現在のユーザー情報取得 | ✅ 実装済み |

#### 記録関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/records | 必要 | 記録一覧取得 | ✅ 実装済み |
| GET | /api/records/:id | 必要 | 特定の記録取得 | ✅ 実装済み |
| POST | /api/records | 必要 | 記録作成（気象データ自動保存） | ✅ 実装済み |
| PUT | /api/records/:id | 必要 | 記録更新 | ✅ 実装済み |
| DELETE | /api/records/:id | 必要 | 記録削除 | ✅ 実装済み |
| GET | /api/records/stats | 必要 | 統計情報取得 | ✅ 実装済み |
| GET | /api/records/chart-data | 必要 | グラフデータ取得（時間単位集約） | ✅ 実装済み |

#### 分析関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/analysis/categories | 必要 | 分析観点一覧取得 | ✅ 実装済み |
| GET | /api/analysis/questions | 必要 | 質問一覧取得 | ✅ 実装済み |
| POST | /api/analysis/answers | 必要 | 回答保存 | ✅ 実装済み |
| GET | /api/analysis/scores | 必要 | 観点別平均スコア取得 | ✅ 実装済み |
| GET | /api/analysis/trends | 必要 | 観点別スコア遷移取得 | ✅ 実装済み |
| GET | /api/analysis/analyze | 必要 | **AI分析実行** | ✅ **実装済み** |

#### アドバイス関連 ✅ **新規実装**

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/advice/personalized | 必要 | **パーソナライズアドバイス取得** | ✅ **実装済み** |
| GET | /api/advice/history | 必要 | **アドバイス履歴取得** | ✅ **実装済み** |

#### 気象データ関連

| メソッド | エンドポイント | 認証 | 説明 | 実装状況 |
|---------|--------------|------|------|---------|
| GET | /api/weather/current | 必要 | 現在の気象データ取得 | ✅ 実装済み |

---

## 6. バックエンド構造

### 6.1 ディレクトリ構成

```
mood-tracker-api/
├── src/
│   ├── config/
│   │   ├── database.ts           # DB接続設定 ✅
│   │   ├── cors.config.ts        # CORS設定 ✅
│   │   └── security.config.ts    # セキュリティ設定 ✅
│   ├── controllers/
│   │   ├── authController.ts     # 認証コントローラー ✅
│   │   ├── recordController.ts   # 記録コントローラー ✅
│   │   ├── analysisController.ts # 分析コントローラー ✅
│   │   ├── adviceController.ts   # アドバイスコントローラー ✅
│   │   └── weatherController.ts  # 気象データコントローラー ✅
│   ├── models/
│   │   ├── User.ts               # ユーザーモデル ✅
│   │   ├── Record.ts             # 記録モデル ✅
│   │   ├── Analysis.ts           # 分析モデル ✅
│   │   ├── Advice.ts             # アドバイスモデル ✅
│   │   └── WeatherData.ts        # 気象データモデル ✅
│   ├── routes/
│   │   ├── authRoutes.ts         # 認証ルート ✅
│   │   ├── recordRoutes.ts       # 記録ルート ✅
│   │   ├── analysisRoutes.ts     # 分析ルート ✅
│   │   ├── adviceRoutes.ts       # アドバイスルート ✅
│   │   └── weatherRoutes.ts      # 気象データルート ✅
│   ├── middleware/
│   │   ├── auth.ts               # 認証ミドルウェア ✅
│   │   └── validation.ts         # バリデーションミドルウェア ✅
│   ├── services/
│   │   ├── weatherService.ts     # 気象データサービス ✅
│   │   └── aiService.ts          # AIサービス ✅
│   ├── types/
│   │   └── index.ts              # TypeScript型定義 ✅
│   ├── tests/                    # テストコード ✅
│   │   └── passwordHelper.test.ts
│   ├── index.ts                  # エントリーポイント ✅
│   └── index.production.ts       # 本番用エントリーポイント ✅
├── .env                          # 環境変数
├── .env.example                  # 環境変数サンプル ✅
├── package.json                  # ✅
├── tsconfig.json                 # ✅
└── jest.config.js                # Jest設定 ✅
```

### 6.2 主要コンポーネント

#### 6.2.1 AIサービス（aiService.ts） ✅ **完全実装**

**責務**:
- Gemini APIとの連携
- AI質問の生成
- データ分析
- アドバイス生成

**実装済み機能**:

**1. Gemini API接続設定**:
```typescript
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');
const model = genAI.getGenerativeModel({ model: 'gemini-pro' });
```

**2. AI質問生成関数** ✅:
```typescript
export async function generateQuestions(
  categoryName: string,
  categoryDescription: string
): Promise<string[]>
```

**3. データ分析関数** ✅:
```typescript
export async function analyzeData(
  records: any[],
  weatherData: any[],
  analysisData: any[]
): Promise<AnalysisResult>
```

**4. パーソナライズアドバイス生成関数** ✅:
```typescript
export async function generatePersonalizedAdvice(
  latestRecord: any,
  recentRecords: any[],
  currentWeather: any,
  analysisResult: any
): Promise<string>
```

---

## 7. フロントエンド構造

### 7.1 ディレクトリ構成

```
mood-tracker-app/
├── src/
│   ├── components/
│   │   ├── layout/
│   │   │   ├── Layout.tsx         # レイアウトコンポーネント ✅
│   │   │   └── Sidebar.tsx        # サイドバー ✅
│   │   ├── Dashboard.tsx          # ダッシュボード ✅
│   │   ├── Dashboard.css
│   │   ├── AdviceCard.tsx         # アドバイスカード ✅
│   │   ├── AdviceCard.css
│   │   ├── AdviceHistory.tsx      # アドバイス履歴 ✅
│   │   ├── AdviceHistory.css
│   │   ├── charts/
│   │   │   ├── MoodChart.tsx      # 気分グラフ ✅
│   │   │   ├── WeatherChart.tsx   # 気象グラフ ✅
│   │   │   ├── CategoryRadarChart.tsx # レーダーチャート ✅
│   │   │   └── CategoryTrendsChart.tsx # スコア遷移 ✅
│   │   ├── RecordForm.tsx         # 記録入力フォーム ✅
│   │   ├── RecordForm.css
│   │   ├── RecordList.tsx         # 記録一覧 ✅
│   │   ├── RecordList.css
│   │   ├── RecordDetail.tsx       # 記録詳細 ✅
│   │   ├── RecordDetail.css
│   │   ├── AnalysisForm.tsx       # 統合分析画面 ✅
│   │   ├── AnalysisForm.css
│   │   ├── Login.tsx              # ログイン画面 ✅
│   │   └── Register.tsx           # 登録画面 ✅
│   ├── services/
│   │   ├── api.ts                 # Axios設定 ✅
│   │   ├── authService.ts         # 認証サービス ✅
│   │   ├── recordService.ts       # 記録サービス ✅
│   │   ├── analysisService.ts     # 分析サービス ✅
│   │   ├── adviceService.ts       # アドバイスサービス ✅
│   │   └── weatherService.ts      # 気象データサービス ✅
│   ├── types/
│   │   └── index.ts               # TypeScript型定義 ✅
│   ├── tests/                     # テストコード ✅
│   │   ├── Login.test.tsx
│   │   ├── auth.spec.ts
│   │   ├── dashboard.spec.ts
│   │   ├── record-form.spec.ts
│   │   ├── record-list.spec.ts
│   │   ├── record-detail.spec.ts
│   │   ├── analysis.spec.ts
│   │   └── advice-history.spec.ts
│   ├── App.tsx                    # ルートコンポーネント ✅
│   ├── App.css
│   ├── main.tsx                   # エントリーポイント ✅
│   ├── setupTests.ts              # テストセットアップ ✅
│   └── vite.config.ts             # Vite設定 ✅
├── public/
├── index.html
├── package.json                   # ✅
├── tsconfig.json                  # ✅
├── playwright.config.ts           # Playwright設定 ✅
└── vercel.json                    # Vercel設定 ✅
```

---

## 8. 認証・認可

### 8.1 認証フロー

#### ユーザー登録フロー

```
1. ユーザーが登録フォームに情報入力
   ↓
2. フロントエンドが /api/auth/register にPOST
   ↓
3. バックエンドがユーザー名・メールの重複チェック
   ↓
4. パスワードをbcryptjsでハッシュ化
   ↓
5. DBにユーザー情報を保存
   ↓
6. JWTトークンを生成
   ↓
7. ユーザー情報とトークンを返却
   ↓
8. フロントエンドがトークンをlocalStorageに保存
   ↓
9. 自動的にダッシュボードに遷移
```

### 8.2 JWT（JSON Web Token）

#### トークンの構成

```
Header.Payload.Signature
```

**Payload（ペイロード）**:
```json
{
  "userId": 1,
  "username": "testuser",
  "iat": 1699000000,
  "exp": 1699604800
}
```

**有効期限**: 7日間

### 8.3 セキュリティ対策

#### パスワード管理
- **ハッシュ化**: bcryptjsを使用（ソルトラウンド: 10）
- **平文保存禁止**: データベースにはハッシュ値のみ保存
- **最小文字数**: 6文字以上

#### トークン管理
- **保存場所**: localStorage
- **自動削除**: ログアウト時、トークン期限切れ時
- **HTTPS**: 本番環境で強制

#### API保護
- **認証必須**: ほとんどのエンドポイントで認証が必要
- **CORS設定**: 許可されたオリジンのみアクセス可能

---

## 9. 外部API連携

### 9.1 WeatherAPI ✅ **実装済み**

#### 概要
気象データを取得するための無料API。

**公式サイト**: https://www.weatherapi.com/

#### 使用方法

**エンドポイント**:
```
GET https://api.weatherapi.com/v1/current.json
```

**パラメータ**:
- `key`: APIキー
- `q`: 都市名（例: Tokyo）
- `aqi`: 大気質情報（no）

#### データの保存タイミング ✅

記録作成時に自動的に気象データを取得・保存。

**処理フロー**:
1. ユーザーが記録を作成
2. RecordModel.create()が記録をDBに保存
3. レスポンスを返却
4. 非同期で getCurrentWeather('Tokyo') を呼び出し
5. 取得した気象データを weather_data テーブルに保存
6. エラーが発生しても記録作成には影響しない

---

### 9.2 Google Gemini API ✅ **完全実装**

#### 概要
AIによる質問生成、データ分析、アドバイス生成に使用。

**公式サイト**: https://ai.google.dev/

#### 実装済み機能

**1. AI質問生成** ✅:
- モデル: gemini-pro
- 分析観点に基づいて5つの質問を生成
- 10段階評価で回答できる形式
- `generated_by_ai = true` でDB保存

**2. データ分析** ✅:
- 記録データ、気象データ、分析回答データを統合分析
- 傾向分析（improving/stable/declining）
- 相関関係の抽出
- 具体的な推奨事項の生成

**3. アドバイス生成** ✅:
- 最新記録、直近記録、気象データを考慮
- パーソナライズされたアドバイス
- アドバイス履歴のDB保存
- トークン消費の最適化

---

## 10. データフロー

### 10.1 記録作成フロー ✅ **完全実装**

```
[ユーザー入力]
    ↓
[RecordForm: 記録入力、気象情報表示]
    ↓
[POST /api/records]
    ↓
[認証MW → バリデーションMW]
    ↓
[recordController.createRecord()]
    ↓
[RecordModel.create()]
    ↓
[PostgreSQL: records表へINSERT]
    ↓
[レスポンス返却]
    |
    ├→ [フロントエンド: 成功メッセージ表示]
    |
    └→ [非同期処理開始]
        ↓
    [weatherService.getCurrentWeather('Tokyo')]
        ↓
    [WeatherAPI呼び出し]
        ↓
    [気象データ取得]
        ↓
    [WeatherDataModel.create()]
        ↓
    [PostgreSQL: weather_data表へINSERT]
        ↓
    [完了（エラーでも記録作成には影響なし）]
```

---

### 10.2 AI分析フロー ✅ **完全実装**

```
[ユーザー: AI分析実行]
    ↓
[AnalysisForm: 期間選択、分析実行ボタン]
    ↓
[GET /api/analysis/analyze?days=14]
    ↓
[認証MW]
    ↓
[analysisController.analyzeUserData()]
    ↓
[AnalysisModel.getAnalysisData()]
    ├→ [records表から記録データ取得]
    ├→ [weather_data表から気象データ取得]
    └→ [analysis_answers表から回答データ取得]
        ↓
    [aiService.analyzeData()]
        ↓
    [Gemini API呼び出し]
        ↓
    [AI分析結果取得（JSON形式）]
        ├→ summary: 全体的な状態
        ├→ trends: 傾向分析
        ├→ correlations: 相関関係
        └→ recommendations: 推奨事項
            ↓
    [分析結果を返却]
        ↓
    [AnalysisForm: 分析結果表示]
```

---

### 10.3 アドバイス生成フロー ✅ **完全実装**

```
[ユーザー: アドバイス生成]
    ↓
[AdviceCard/AdviceHistory: 生成ボタンクリック]
    ↓
[GET /api/advice/personalized]
    ↓
[認証MW]
    ↓
[adviceController.getPersonalizedAdvice()]
    ├→ [RecordModel: 最新記録取得]
    ├→ [RecordModel: 直近7日間の記録取得]
    ├→ [weatherService: 現在の気象データ取得]
    └→ [analysisService: AI分析結果取得]
        ↓
    [aiService.generatePersonalizedAdvice()]
        ↓
    [Gemini API呼び出し]
        ↓
    [パーソナライズアドバイス生成]
        ↓
    [AdviceModel.create(): DB保存]
        ↓
    [advice_history表へINSERT]
        ↓
    [アドバイスを返却]
        ↓
    [フロントエンド: アドバイス表示]
```

---

## 11. 主要機能詳細

### 11.1 記録入力機能 ✅ **実装済み**

#### 機能概要
ユーザーが日々の調子を記録するためのフォーム機能。

#### 入力項目
1. **睡眠**: 睡眠時間、睡眠の質（1～10段階）
2. **食事**: 食事の質、食事の規則性（1～10段階）
3. **運動**: 運動時間、運動強度（1～10段階）
4. **感情**: 感情スコア、感情メモ（1～10段階、自由記述）
5. **モチベーション**: モチベーションスコア（1～10段階）
6. **活動内容**: やったこと（自由記述）

#### 自動処理
- 記録時刻の自動設定
- **気象データの自動取得・保存** ✅
- データベースへの保存

#### 気象データ表示 ✅
- 記録作成時に現在の気象データを表示
- 気象情報カード（気温、湿度、天気、位置情報）
- 天気アイコンの自動選択

---

### 11.2 自己分析機能 ✅ **完全実装**

#### 質問表示 ✅
- 分析観点ごとの質問を表示
- 10段階評価での回答
- AI生成の質問も表示可能

#### 統合分析画面 ✅
- 期間選択機能（今日/直近3日間/1週間/3週間）
- レーダーチャートによる観点別スコア表示
- スコア遷移グラフの実装
- AI分析結果の統合表示
- 非同期ローディング最適化

#### AI質問生成 ✅ **バックエンド完全実装**
- Claude API による動的な質問生成
- 分析観点に基づいて5つの質問を生成
- 10段階評価で回答できる形式
- `generated_by_ai = true` でDB保存

---

### 11.3 ダッシュボード機能 ✅ **完全実装**

#### 表示コンテンツ

**1. アドバイスカード** ✅:
- 最新のパーソナライズアドバイス表示
- 手動更新ボタン
- アドバイス履歴へのリンク

**2. グラフセクション** ✅:
- 気分とモチベーションの推移
- 気温と湿度の推移
- 時間単位でのデータ集約
- 動的な軸範囲調整

**3. 統計パネル** ✅:
- 総記録数
- 今週の記録数
- 平均感情スコア
- 平均モチベーション

**4. クイックアクション** ✅:
- 新規記録作成ボタン
- 自己分析実施ボタン

**5. 最近の記録** ✅:
- 直近10件の記録をカード形式で表示
- クリックで詳細画面に遷移

---

### 11.4 アドバイス機能 ✅ **完全実装**

#### パーソナライズアドバイス生成 ✅
- 最新記録を基に生成
- 直近7日間の記録傾向を考慮
- 現在の気象データを考慮
- AI分析結果を統合

#### アドバイス履歴 ✅
- 過去のアドバイス一覧表示
- カード形式で表示
- 新しいアドバイス生成機能
- 相対時刻表示（「5分前」「昨日」）

---

## 12. テストとCI/CD

### 12.1 テスト戦略 ✅ **完全実装**

#### ユニットテスト ✅
**バックエンド（Jest）**:
- passwordHelper.test.ts: パスワードハッシュ化のテスト
- カバレッジ計測: `npm run test:coverage`

**フロントエンド（Vitest）**:
- Login.test.tsx: Loginコンポーネントのテスト
- React Testing Library使用
- カバレッジ計測: `npm run test:unit`

#### E2Eテスト（Playwright） ✅
**7つのテストファイル、54テストケース**:
1. auth.spec.ts: 認証機能（6テスト）
2. dashboard.spec.ts: ダッシュボード（10テスト）
3. record-form.spec.ts: 記録作成（10テスト）
4. record-list.spec.ts: 記録一覧（8テスト）
5. record-detail.spec.ts: 記録詳細（5テスト）
6. analysis.spec.ts: 分析画面（6テスト）
7. advice-history.spec.ts: アドバイス履歴（9テスト）

**テスト対象コンポーネント**:
- Login.tsx、Register.tsx、Dashboard.tsx
- AdviceCard.tsx、AdviceHistory.tsx
- RecordForm.tsx、RecordList.tsx、RecordDetail.tsx
- AnalysisForm.tsx

---

### 12.2 CI/CD パイプライン ✅ **完全実装**

#### GitHub Actions ワークフロー ✅

**フロントエンドCI（frontend-ci.yml）**:
- トリガー: main/developブランチへのプッシュ/PR
- パス指定: mood-tracker-app/ディレクトリ
- testジョブ:
  - Node.js 20環境セットアップ
  - npm ciで依存関係インストール
  - Vitestでユニットテスト実行
  - Playwrightブラウザインストール
  - PlaywrightでE2Eテスト実行（54ケース）
  - テスト結果とスクリーンショット保存
- buildジョブ:
  - npm run buildでビルド確認
  - ビルド成果物保存

**バックエンドCI（backend-ci.yml）**:
- トリガー: main/developブランチへのプッシュ/PR
- パス指定: mood-tracker-api/ディレクトリ
- PostgreSQL 15サービスコンテナ起動
- testジョブ:
  - Node.js 20環境セットアップ
  - npm ciで依存関係インストール
  - migration.sqlでテスト用DB初期化
  - Jestでユニットテスト実行
  - テストカバレッジレポート生成
  - カバレッジレポート保存
- buildジョブ:
  - TypeScriptビルド確認

**アーティファクト保存期間**:
- playwright-report: 30日間
- playwright-screenshots: 30日間
- build-output: 7日間
- coverage-report: 30日間

---

### 12.3 テストカバレッジ ✅

**フロントエンド**:
- ユニットテスト: Vitest
- E2Eテスト: Playwright（7ファイル、54テストケース）
- テスト対象: 9コンポーネント

**バックエンド**:
- ユニットテスト: Jest
- テストカバレッジ計測: jest --coverage

---

## 13. デプロイメント

### 13.1 デプロイメント構成 ✅ **運用中**

```
インターネット
    ↓
[Vercel] - フロントエンド（React SPA）
    ↓ HTTPS API呼び出し
[Render.com] - バックエンド（Express API）
    ↓ PostgreSQL接続
[Supabase] - データベース（PostgreSQL）
```

---

### 13.2 デプロイ済み環境 ✅

#### フロントエンド（Vercel） ✅
- **プラットフォーム**: Vercel
- **ビルドコマンド**: `npm run build`
- **出力ディレクトリ**: `dist/`
- **環境変数**: VITE_API_URL
- **特徴**: Git連携による自動デプロイ

#### バックエンド（Render.com） ✅
- **プラットフォーム**: Render.com
- **サービスタイプ**: Web Service
- **ビルドコマンド**: `npm install && npm run build`
- **起動コマンド**: `npm run start:prod`
- **環境変数**:
  - DATABASE_URL（Supabase Connection Pooler）
  - JWT_SECRET
  - GEMINI_API_KEY
  - WEATHER_API_KEY
  - WEATHER_API_URL
- **特徴**: Git連携による自動デプロイ

#### データベース（Supabase） ✅
- **プラットフォーム**: Supabase
- **データベース**: PostgreSQL 15
- **接続方法**: Connection Pooler（トランザクションモード）
- **マイグレーション**: migration.sql実行済み
- **テーブル**: 全7テーブル作成済み

---

### 13.3 デプロイ手順 ✅

#### 初回デプロイ手順

**1. Supabaseセットアップ**:
- プロジェクト作成
- migration.sql実行
- Connection Pooler URLを取得

**2. Render.comデプロイ**:
- GitHubリポジトリ連携
- 環境変数設定
- 自動デプロイ実行

**3. Vercelデプロイ**:
- GitHubリポジトリ連携
- 環境変数設定（VITE_API_URL）
- 自動デプロイ実行

---

### 13.4 トラブルシューティング実績 ✅

#### 解決済みの問題

**1. TypeScriptビルドエラー**:
- 問題: strict modeによる型エラー
- 解決: tsconfig.jsonのstrictを調整

**2. bcryptネイティブモジュール問題**:
- 問題: Render.comでbcryptがビルドできない
- 解決: bcrypt → bcryptjsへ切り替え

**3. データベース接続問題**:
- 問題: DATABASE_URL未設定
- 解決: Connection Pooler URLを環境変数に設定

**4. advice_historyテーブル未作成**:
- 問題: テーブルが存在しないエラー
- 解決: SQLクエリでテーブル作成

**5. CORS問題**:
- 問題: フロントエンドからのAPI呼び出しがブロックされる
- 解決: cors.config.tsでVercel URLを許可

---

### 13.5 モニタリングと保守 ✅

#### ログ確認
- Render.com: ダッシュボードでリアルタイムログ確認
- Vercel: ダッシュボードでデプロイログ確認

#### パフォーマンス
- フロントエンド: Vercelの自動最適化
- バックエンド: Connection Poolerによる効率的なDB接続

#### バックアップ
- Supabase: 自動バックアップ機能
- Git: コードのバージョン管理

---

## 14. 実装状況

### 14.1 実装完了機能 ✅

#### Phase 1: 環境構築と基礎知識 ✅
1. ✅ 開発環境構築
2. ✅ React基礎
3. ✅ Node.js + Express基礎

#### Phase 2: 基本機能実装 ✅
1. ✅ データベース設計
2. ✅ バックエンドAPI実装
3. ✅ フロントエンドとバックエンドの連携
4. ✅ バリデーション実装

#### Phase 3: 主要機能実装 ✅
1. ✅ 記録入力画面の実装（気象データ表示含む）
2. ✅ 自己分析機能（質問表示・回答保存）
3. ✅ ダッシュボード基礎（レイアウト・統計パネル）
4. ✅ データ可視化（グラフ表示、時間単位集約、動的範囲調整）
5. ✅ 気象データ連携（自動取得・保存・表示）

#### Phase 4: AI機能統合とフロント実装 ✅
1. ✅ Claude API基礎
2. ✅ AI質問生成機能
3. ✅ データ分析機能
4. ✅ アドバイス生成機能
5. ✅ ダッシュボードでのアドバイス表示
6. ✅ アドバイス履歴画面
7. ✅ 統合分析画面

#### Phase 5: テストとCI/CD ✅
1. ✅ ユニットテスト（Jest、Vitest）
2. ✅ E2Eテスト（Playwright、54ケース）
3. ✅ CI/CD構築（GitHub Actions）

#### Phase 6: デプロイと最適化 ✅
1. ✅ デプロイ準備（設定ファイル、ドキュメント）
2. ✅ デプロイ実施（Vercel、Render.com、Supabase）

---

### 14.2 プロジェクト完了状況 🎉

**全24ステップ完了: 100%**

**完了日**: 2025年11月28日

**達成した目標**:
- ✅ フルスタックWebアプリケーションの構築
- ✅ AI機能の統合（Claude API）
- ✅ 包括的なテストの実装
- ✅ CI/CD環境の構築
- ✅ 本番環境へのデプロイ

---

### 14.3 技術的な成果

#### 習得したスキル

**フロントエンド**（基礎～応用）:
- React 18 + TypeScript
- コンポーネント設計とState管理
- データ可視化（Chart.js）
- レスポンシブデザイン
- 非同期処理の最適化

**バックエンド**（基礎～応用）:
- Node.js + Express + TypeScript
- RESTful API設計
- PostgreSQLデータベース操作
- JWT認証
- 外部API連携

**AI統合**（基礎～応用）:
- LLM API（Gemini）の活用
- プロンプトエンジニアリング
- 構造化されたレスポンス取得
- パーソナライズ機能の実装

**テストとCI/CD**（基礎）:
- ユニットテスト（Jest、Vitest）
- E2Eテスト（Playwright）
- GitHub Actions
- 継続的インテグレーション

**デプロイメント**（基礎）:
- 無償ホスティングサービスの活用
- 本番環境の設定
- トラブルシューティング

---

### 14.4 今後の改善案

#### 短期的な改善
1. 位置情報の動的取得（現在は'Tokyo'固定）
2. E2Eテストのカバレッジ拡大
3. パフォーマンス最適化
4. エラーロギングの改善

#### 中期的な改善
1. 通知機能の実装
2. ソーシャル機能の追加
3. レポート機能の強化
4. 多言語対応

#### 長期的な改善
1. ウェアラブルデバイス連携
2. AI精度の向上
3. リアルタイム分析機能
4. モバイルアプリの開発

---

## まとめ

本システムは、React + TypeScript のフロントエンドと Node.js + Express + PostgreSQL のバックエンドで構成される、AIを活用した調子記録Webアプリケーションであり、**全機能が実装完了し、本番環境で稼働中**である。

**主要な特徴**:
- JWT認証による安全なユーザー管理
- RESTful APIによる明確な責任分離
- PostgreSQLによる堅牢なデータ管理
- Chart.jsによる直感的なデータ可視化
- 外部APIとの連携（気象データ、AI機能）
- スケーラブルなアーキテクチャ設計
- 包括的なテスト（ユニット、E2E）
- CI/CD環境（GitHub Actions）
- 本番環境デプロイ（Vercel、Render.com、Supabase）

**技術的な強み**:
- TypeScriptによる型安全性
- MVCパターンによる保守性の高い設計
- 非同期処理による高いパフォーマンス
- レスポンシブデザインによるマルチデバイス対応
- プロンプトエンジニアリングによるAI活用
- 自動テストによる品質保証
- CI/CDによる継続的な改善

**プロジェクトの価値**:
このプロジェクトを通じて、モダンなWebアプリケーション開発の全体像を理解し、フロントエンド、バックエンド、AI統合、テスト、CI/CD、デプロイメントといった実務で重要な技術を実装し、習得することができた。

本定義書は、システムの全体像を理解し、今後の保守や機能拡張を円滑に進めるための基礎資料として活用される。

---

**文書バージョン**: 4.0  
**作成日**: 2025年11月7日  
**最終更新日**: 2025年11月28日  
**更新内容**: Phase 4〜6完了、テスト・CI/CD・デプロイ完了、プロジェクト100%完了を反映
