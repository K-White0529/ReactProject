# 調子記録アプリ システム設計定義書

## 目次

1. [システム概要](#1-システム概要)
2. [技術スタック](#2-技術スタック)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [データベース設計](#4-データベース設計)
5. [API設計](#5-api設計)
6. [バックエンド構造](#6-バックエンド構造)
7. [フロントエンド構造](#7-フロントエンド構造)
8. [認証・認可](#8-認証認可)
9. [外部API連携](#9-外部api連携)
10. [データフロー](#10-データフロー)
11. [主要機能詳細](#11-主要機能詳細)

---

## 1. システム概要

### 1.1 アプリケーション名
**Mood Tracker - AIを活用した調子記録アプリ**

### 1.2 目的
ユーザーが日々の調子を記録し、AIによる分析とアドバイスを受けることで、自己理解を深め、より良い生活習慣を構築することを支援するWebアプリケーション。

### 1.3 主要機能
- ユーザー認証（登録・ログイン）
- 調子データの記録（体調、気分、活動内容など）
- 自己分析質問への回答（10段階評価）
- 気象データの自動取得・記録
- ダッシュボードでのデータ可視化（グラフ表示）
- 記録の一覧表示・詳細表示
- AIによるデータ分析とアドバイス生成

### 1.4 ターゲットユーザー
自己管理を行いたい個人ユーザー

---

## 2. 技術スタック

### 2.1 フロントエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| React | 18.x | UIライブラリ |
| TypeScript | 5.x | 型安全な開発 |
| Vite | 5.x | ビルドツール・開発サーバー |
| Axios | 1.x | HTTP通信 |
| Chart.js | 4.x | データ可視化 |
| React Icons | 5.x | アイコン表示 |

### 2.2 バックエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Node.js | 20.x LTS | ランタイム環境 |
| Express | 4.x | Webフレームワーク |
| TypeScript | 5.x | 型安全な開発 |
| pg (node-postgres) | 8.x | PostgreSQLクライアント |
| bcrypt | 5.x | パスワードハッシュ化 |
| jsonwebtoken | 9.x | JWT認証 |
| express-validator | 7.x | バリデーション |
| dotenv | 16.x | 環境変数管理 |

### 2.3 データベース
| 技術 | バージョン | 用途 |
|------|-----------|------|
| PostgreSQL | 16.x | リレーショナルデータベース |

### 2.4 外部API
| サービス | 用途 |
|---------|------|
| Google Gemini API | AI分析・アドバイス生成 |
| WeatherAPI | 気象データ取得 |

### 2.5 開発環境
| ツール | 用途 |
|--------|------|
| VSCode | エディタ |
| Git | バージョン管理 |
| npm | パッケージ管理 |

---

## 3. システムアーキテクチャ

### 3.1 全体構成

```
┌─────────────────┐
│   ブラウザ      │
│   (React)       │
└────────┬────────┘
         │ HTTP/HTTPS
         │ (REST API)
         │
┌────────┴────────┐
│ Express Server  │
│   (Node.js)     │
└────────┬────────┘
         │
    ┌────┴────┬────────────┐
    │         │            │
    │         │            │
┌───┴───┐ ┌──┴──────┐ ┌──┴─────────┐
│PostgreSQL│ │Gemini API│ │WeatherAPI│
└─────────┘ └─────────┘ └──────────┘
```

### 3.2 アーキテクチャパターン
- **フロントエンド**: コンポーネントベースアーキテクチャ
- **バックエンド**: MVC（Model-View-Controller）パターン
- **通信**: RESTful API
- **認証**: JWT（JSON Web Token）ベース

### 3.3 レイヤー構成

#### フロントエンド
```
Presentation Layer (Components)
        ↓
Service Layer (API Clients)
        ↓
HTTP Client (Axios)
```

#### バックエンド
```
Route Layer (ルーティング)
        ↓
Controller Layer (ビジネスロジック)
        ↓
Model Layer (データアクセス)
        ↓
Database (PostgreSQL)
```

---

## 4. データベース設計

### 4.1 ER図

```
┌──────────────┐
│    users     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────┴───────┐
│   records    │
└──────────────┘
       │ 1
       ├─────────────────────┐
       │                     │
       │ N                   │ N
┌──────┴──────────┐  ┌──────┴─────────┐
│analysis_answers │  │  weather_data  │
└─────────────────┘  └────────────────┘
       │ N
       │
       │ 1
┌──────┴──────────────┐
│analysis_questions   │
└─────────────────────┘
       │ N
       │
       │ 1
┌──────┴──────────────┐
│analysis_categories  │
└─────────────────────┘

┌──────────────┐
│    users     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────┴───────────┐
│advice_history    │
└──────────────────┘
```

### 4.2 テーブル定義

#### 4.2.1 users（ユーザー情報）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | ユーザーID（自動採番） |
| username | VARCHAR(50) | UNIQUE NOT NULL | ユーザー名 |
| email | VARCHAR(255) | UNIQUE NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ値 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**: なし（PRIMARY KEYとUNIQUE制約により自動作成）

---

#### 4.2.2 records（記録データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 記録ID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| recorded_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 記録日時 |
| sleep_hours | DECIMAL(3,1) | NULL | 睡眠時間（時間） |
| sleep_quality | INTEGER | CHECK (1～10), NULL | 睡眠の質（10段階） |
| meal_quality | INTEGER | CHECK (1～10), NULL | 食事の質（10段階） |
| meal_regularity | INTEGER | CHECK (1～10), NULL | 食事の規則性（10段階） |
| exercise_minutes | INTEGER | NULL | 運動時間（分） |
| exercise_intensity | INTEGER | CHECK (1～10), NULL | 運動強度（10段階） |
| emotion_score | INTEGER | CHECK (1～10), NULL | 感情スコア（10段階） |
| emotion_note | TEXT | NULL | 感情に関するメモ |
| motivation_score | INTEGER | CHECK (1～10), NULL | モチベーション（10段階） |
| activities_done | TEXT | NULL | やったこと（自由記述） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_records_user_id` ON (user_id)
- `idx_records_recorded_at` ON (recorded_at)

---

#### 4.2.3 analysis_categories（分析観点マスタ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 観点ID（自動採番） |
| code | VARCHAR(50) | UNIQUE NOT NULL | 観点コード |
| name | VARCHAR(100) | NOT NULL | 観点名称 |
| description | TEXT | NULL | 説明 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**初期データ**:
- code='stress', name='ストレス'
- code='concentration', name='集中力'
- code='motivation', name='モチベーション'

---

#### 4.2.4 analysis_questions（質問マスタ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 質問ID（自動採番） |
| category_id | INTEGER | NOT NULL, REFERENCES analysis_categories(id) ON DELETE CASCADE | 分析観点ID |
| question_text | TEXT | NOT NULL | 質問文 |
| is_active | BOOLEAN | DEFAULT true | 有効フラグ |
| generated_by_ai | BOOLEAN | DEFAULT false | AI生成フラグ |
| usage_count | INTEGER | DEFAULT 0 | 使用回数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
- `idx_questions_category_id` ON (category_id)
- `idx_questions_is_active` ON (is_active)

---

#### 4.2.5 analysis_answers（回答データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 回答ID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| record_id | INTEGER | REFERENCES records(id) ON DELETE CASCADE, NULL | 記録ID（任意） |
| question_id | INTEGER | NOT NULL, REFERENCES analysis_questions(id) ON DELETE CASCADE | 質問ID |
| answer_score | INTEGER | NOT NULL, CHECK (1～10) | 回答スコア（10段階） |
| answered_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 回答日時 |

**インデックス**:
- `idx_answers_user_id` ON (user_id)
- `idx_answers_record_id` ON (record_id)
- `idx_answers_question_id` ON (question_id)
- `idx_answers_answered_at` ON (answered_at)

---

#### 4.2.6 weather_data（気象データ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 気象データID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| recorded_at | TIMESTAMP | NOT NULL | 記録日時 |
| temperature | DECIMAL(4,1) | NULL | 気温（℃） |
| humidity | INTEGER | NULL | 湿度（%） |
| pressure | DECIMAL(6,2) | NULL | 気圧（hPa） |
| weather_condition | VARCHAR(100) | NULL | 天気の状態 |
| weather_description | TEXT | NULL | 詳細な天気説明 |
| season | VARCHAR(20) | NULL | 季節 |
| location | VARCHAR(255) | NULL | 位置情報 |
| api_source | VARCHAR(50) | NULL | データ取得元API |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
- `idx_weather_user_id` ON (user_id)
- `idx_weather_recorded_at` ON (recorded_at)

---

#### 4.2.7 advice_history（アドバイス履歴）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | アドバイスID（自動採番） |
| user_id | INTEGER | NOT NULL, REFERENCES users(id) ON DELETE CASCADE | ユーザーID |
| advice_text | TEXT | NOT NULL | アドバイス本文 |
| advice_type | VARCHAR(50) | NULL | アドバイスの種類 |
| based_on_data | JSONB | NULL | 生成に使用したデータ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| displayed_at | TIMESTAMP | NULL | 表示日時 |
| was_helpful | BOOLEAN | NULL | 役立ったかのフィードバック |

**インデックス**:
- `idx_advice_user_id` ON (user_id)
- `idx_advice_created_at` ON (created_at)

---

### 4.3 リレーションシップ

#### 主要な関係性

1. **users → records**: 1対多（1ユーザーは複数の記録を持つ）
2. **users → analysis_answers**: 1対多（1ユーザーは複数の回答を持つ）
3. **users → weather_data**: 1対多（1ユーザーは複数の気象データを持つ）
4. **users → advice_history**: 1対多（1ユーザーは複数のアドバイスを受ける）
5. **analysis_categories → analysis_questions**: 1対多（1観点は複数の質問を持つ）
6. **analysis_questions → analysis_answers**: 1対多（1質問は複数の回答を持つ）
7. **records → analysis_answers**: 1対多（1記録は複数の回答を持つ、任意）

#### CASCADE削除の設計思想

- ユーザーが削除された場合、そのユーザーに紐づく全データを削除（`ON DELETE CASCADE`）
- データの整合性を保つため、親エンティティの削除時に子エンティティも自動削除

---

## 5. API設計

### 5.1 APIエンドポイント一覧

#### 認証関連

| メソッド | エンドポイント | 認証 | 説明 |
|---------|--------------|------|------|
| POST | /api/auth/register | 不要 | ユーザー登録 |
| POST | /api/auth/login | 不要 | ログイン |
| GET | /api/auth/me | 必要 | 現在のユーザー情報取得 |

#### 記録関連

| メソッド | エンドポイント | 認証 | 説明 |
|---------|--------------|------|------|
| GET | /api/records | 必要 | 記録一覧取得 |
| GET | /api/records/:id | 必要 | 特定の記録取得 |
| POST | /api/records | 必要 | 記録作成 |
| PUT | /api/records/:id | 必要 | 記録更新 |
| DELETE | /api/records/:id | 必要 | 記録削除 |
| GET | /api/records/stats | 必要 | 統計情報取得 |
| GET | /api/records/chart | 必要 | グラフデータ取得 |

#### 分析関連

| メソッド | エンドポイント | 認証 | 説明 |
|---------|--------------|------|------|
| GET | /api/analysis/categories | 必要 | 分析観点一覧取得 |
| GET | /api/analysis/questions | 必要 | 質問一覧取得 |
| POST | /api/analysis/answers | 必要 | 回答保存 |

#### 気象データ関連

| メソッド | エンドポイント | 認証 | 説明 |
|---------|--------------|------|------|
| GET | /api/weather/current | 必要 | 現在の気象データ取得 |

---

### 5.2 APIリクエスト・レスポンス詳細

#### 5.2.1 ユーザー登録

**リクエスト**
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "message": "ユーザー登録が完了しました"
}
```

**レスポンス（エラー）**
```json
{
  "success": false,
  "message": "既に存在するユーザー名です"
}
```

---

#### 5.2.2 ログイン

**リクエスト**
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "message": "ログインに成功しました"
}
```

---

#### 5.2.3 記録作成

**リクエスト**
```http
POST /api/records
Authorization: Bearer {token}
Content-Type: application/json

{
  "sleep_hours": 7.5,
  "sleep_quality": 8,
  "meal_quality": 7,
  "meal_regularity": 8,
  "exercise_minutes": 30,
  "exercise_intensity": 6,
  "emotion_score": 8,
  "emotion_note": "今日は気分が良い",
  "motivation_score": 7,
  "activities_done": "プロジェクトのドキュメントを作成した"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "user_id": 1,
    "recorded_at": "2025-11-07T12:00:00.000Z",
    "sleep_hours": 7.5,
    "sleep_quality": 8,
    "meal_quality": 7,
    "meal_regularity": 8,
    "exercise_minutes": 30,
    "exercise_intensity": 6,
    "emotion_score": 8,
    "emotion_note": "今日は気分が良い",
    "motivation_score": 7,
    "activities_done": "プロジェクトのドキュメントを作成した",
    "created_at": "2025-11-07T12:00:00.000Z",
    "updated_at": "2025-11-07T12:00:00.000Z"
  },
  "message": "記録を作成しました"
}
```

---

#### 5.2.4 統計情報取得

**リクエスト**
```http
GET /api/records/stats
Authorization: Bearer {token}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "total_records": 25,
    "this_week_records": 5,
    "avg_emotion_score": 7.5,
    "avg_motivation_score": 6.8,
    "latest_record_date": "2025-11-07T12:00:00.000Z"
  }
}
```

---

#### 5.2.5 グラフデータ取得

**リクエスト**
```http
GET /api/records/chart
Authorization: Bearer {token}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "mood": [
      {
        "date": "2025-11-01",
        "avg_emotion": 7.5,
        "avg_motivation": 6.8
      },
      {
        "date": "2025-11-02",
        "avg_emotion": 8.0,
        "avg_motivation": 7.2
      }
    ],
    "weather": [
      {
        "date": "2025-11-01",
        "avg_temperature": 18.5,
        "avg_humidity": 65,
        "weather_condition": "Partly cloudy"
      },
      {
        "date": "2025-11-02",
        "avg_temperature": 20.0,
        "avg_humidity": 60,
        "weather_condition": "Sunny"
      }
    ]
  }
}
```

---

#### 5.2.6 質問一覧取得

**リクエスト**
```http
GET /api/analysis/questions
Authorization: Bearer {token}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "category_id": 1,
      "question_text": "今日のストレスレベルはどの程度ですか？",
      "is_active": true,
      "generated_by_ai": false
    },
    {
      "id": 2,
      "category_id": 2,
      "question_text": "今日の集中力はどの程度でしたか？",
      "is_active": true,
      "generated_by_ai": false
    }
  ]
}
```

---

#### 5.2.7 回答保存

**リクエスト**
```http
POST /api/analysis/answers
Authorization: Bearer {token}
Content-Type: application/json

{
  "answers": [
    {
      "question_id": 1,
      "answer_score": 7,
      "record_id": 1
    },
    {
      "question_id": 2,
      "answer_score": 8,
      "record_id": 1
    }
  ]
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "message": "回答を保存しました"
}
```

---

### 5.3 エラーレスポンス形式

全てのAPIエラーは以下の形式で返却される。

```json
{
  "success": false,
  "message": "エラーメッセージ"
}
```

**HTTPステータスコード**:
- 200: 成功
- 201: 作成成功
- 400: バリデーションエラー
- 401: 認証エラー
- 404: リソースが見つからない
- 500: サーバーエラー

---

## 6. バックエンド構造

### 6.1 ディレクトリ構成

```
mood-tracker-backend/
├── src/
│   ├── config/
│   │   └── database.ts           # DB接続設定
│   ├── controllers/
│   │   ├── authController.ts     # 認証コントローラー
│   │   ├── recordController.ts   # 記録コントローラー
│   │   ├── analysisController.ts # 分析コントローラー
│   │   └── weatherController.ts  # 気象データコントローラー
│   ├── models/
│   │   ├── User.ts               # ユーザーモデル
│   │   ├── Record.ts             # 記録モデル
│   │   ├── Analysis.ts           # 分析モデル
│   │   └── WeatherData.ts        # 気象データモデル
│   ├── routes/
│   │   ├── authRoutes.ts         # 認証ルート
│   │   ├── recordRoutes.ts       # 記録ルート
│   │   ├── analysisRoutes.ts     # 分析ルート
│   │   └── weatherRoutes.ts      # 気象データルート
│   ├── middleware/
│   │   ├── auth.ts               # 認証ミドルウェア
│   │   └── validation.ts         # バリデーションミドルウェア
│   ├── services/
│   │   ├── weatherService.ts     # 気象データサービス
│   │   └── aiService.ts          # AIサービス（予定）
│   ├── utils/
│   │   └── passwordHelper.ts     # パスワードヘルパー
│   ├── types/
│   │   └── index.ts              # TypeScript型定義
│   ├── scripts/
│   │   └── migrate.ts            # マイグレーションスクリプト
│   └── index.ts                  # エントリーポイント
├── migrations/
│   ├── 001_initial_schema.sql    # 初期スキーマ
│   └── 002_seed_data.sql         # 初期データ
├── .env                          # 環境変数
├── .env.example                  # 環境変数サンプル
├── package.json
└── tsconfig.json
```

### 6.2 主要コンポーネント

#### 6.2.1 データベース接続（database.ts）

PostgreSQLへの接続プールを管理。

**責務**:
- 接続プールの作成と管理
- データベース接続の提供

**実装パターン**:
```typescript
import { Pool } from 'pg';

const pool = new Pool({
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
});

export default pool;
```

---

#### 6.2.2 認証ミドルウェア（auth.ts）

JWTトークンの検証を行う。

**責務**:
- リクエストヘッダーからトークン抽出
- トークンの検証
- ユーザー情報のリクエストへの付与

**処理フロー**:
1. Authorizationヘッダーからトークン取得
2. JWT検証
3. 検証成功 → req.userにユーザー情報を設定
4. 検証失敗 → 401エラーを返却

---

#### 6.2.3 バリデーションミドルウェア（validation.ts）

express-validatorを使用したリクエストバリデーション。

**責務**:
- リクエストデータの妥当性検証
- バリデーションエラーの収集と返却

**バリデーションルール例**:
- ユーザー名: 3文字以上、50文字以内
- メールアドレス: 有効なメール形式
- パスワード: 6文字以上
- スコア: 1～10の整数

---

#### 6.2.4 モデル層

各テーブルに対応するデータアクセスロジックを実装。

**UserModel**:
- findByUsername(): ユーザー名でユーザー検索
- findByEmail(): メールでユーザー検索
- findById(): IDでユーザー検索
- create(): ユーザー作成

**RecordModel**:
- findByUserId(): ユーザーの記録一覧取得
- findById(): 特定の記録取得
- create(): 記録作成
- update(): 記録更新
- delete(): 記録削除
- getStats(): 統計情報取得
- getChartData(): グラフデータ取得
- getWeatherChartData(): 気象グラフデータ取得

**AnalysisModel**:
- getCategories(): 分析観点取得
- getActiveQuestions(): 有効な質問取得
- saveAnswers(): 回答保存

**WeatherDataModel**:
- save(): 気象データ保存
- findByUserIdAndDate(): 特定日時の気象データ取得

---

#### 6.2.5 コントローラー層

ビジネスロジックの実装とレスポンス生成。

**責務**:
- リクエストの受け取り
- モデル層の呼び出し
- レスポンスの生成
- エラーハンドリング

**実装パターン**:
```typescript
export async function createRecord(req: Request, res: Response): Promise<void> {
  try {
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ success: false, message: '認証が必要です' });
      return;
    }
    
    const recordData: RecordInput = req.body;
    const record = await RecordModel.create(userId, recordData);
    
    res.status(201).json({
      success: true,
      data: record,
      message: '記録を作成しました'
    });
  } catch (error) {
    console.error('記録作成エラー:', error);
    res.status(500).json({
      success: false,
      message: '記録の作成に失敗しました'
    });
  }
}
```

---

#### 6.2.6 サービス層

外部APIとの連携ロジックを実装。

**weatherService.ts**:
- getCurrentWeather(): WeatherAPIから現在の気象データ取得
- 都市名を受け取り、気象データを返却
- エラーハンドリングとフォールバック処理

**aiService.ts（今後実装予定）**:
- generateQuestions(): AI質問生成
- analyzeData(): データ分析
- generateAdvice(): アドバイス生成

---

### 6.3 環境変数

**.env ファイル**:
```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=mood_tracker_db
DB_USER=postgres
DB_PASSWORD=your_password

# Server
PORT=3000

# JWT
JWT_SECRET=your_jwt_secret_key_here

# Weather API
WEATHER_API_KEY=your_weather_api_key

# AI API (予定)
GEMINI_API_KEY=your_gemini_api_key
```

---

## 7. フロントエンド構造

### 7.1 ディレクトリ構成

```
mood-tracker-app/
├── src/
│   ├── components/
│   │   ├── Layout/
│   │   │   ├── Layout.tsx         # レイアウトコンポーネント
│   │   │   ├── Sidebar.tsx        # サイドバー
│   │   │   └── Layout.css
│   │   ├── Dashboard/
│   │   │   ├── Dashboard.tsx      # ダッシュボード
│   │   │   ├── MoodChart.tsx      # 気分グラフ
│   │   │   ├── WeatherChart.tsx   # 気象グラフ
│   │   │   └── Dashboard.css
│   │   ├── Record/
│   │   │   ├── RecordForm.tsx     # 記録入力フォーム
│   │   │   ├── RecordList.tsx     # 記録一覧
│   │   │   ├── RecordDetail.tsx   # 記録詳細
│   │   │   └── RecordForm.css
│   │   └── Auth/
│   │       ├── Login.tsx          # ログイン画面
│   │       ├── Register.tsx       # 登録画面
│   │       └── Auth.css
│   ├── services/
│   │   ├── api.ts                 # Axios設定
│   │   ├── authService.ts         # 認証サービス
│   │   └── recordService.ts       # 記録サービス
│   ├── contexts/
│   │   └── AuthContext.tsx        # 認証コンテキスト
│   ├── types/
│   │   └── index.ts               # TypeScript型定義
│   ├── App.tsx                    # ルートコンポーネント
│   ├── App.css
│   └── main.tsx                   # エントリーポイント
├── public/
├── index.html
├── package.json
├── tsconfig.json
└── vite.config.ts
```

### 7.2 主要コンポーネント

#### 7.2.1 認証コンテキスト（AuthContext.tsx）

アプリケーション全体で認証状態を管理。

**機能**:
- ログイン状態の保持
- トークンの管理（localStorageに保存）
- ログイン・ログアウト処理
- 自動ログイン（トークン有効性チェック）

**提供する値**:
- user: 現在のユーザー情報
- token: JWTトークン
- login(): ログイン関数
- logout(): ログアウト関数
- loading: ロード中フラグ

---

#### 7.2.2 レイアウトコンポーネント（Layout.tsx）

アプリケーション全体のレイアウトを提供。

**構成**:
- サイドバー（Sidebar）
- メインコンテンツエリア
- レスポンシブ対応

---

#### 7.2.3 サイドバー（Sidebar.tsx）

ナビゲーションメニューを提供。

**メニュー項目**:
- ダッシュボード
- データ登録
- 記録一覧
- ユーザーメニュー（ログアウト）

**機能**:
- 現在のページの視覚的なハイライト
- 開閉可能なサイドバー
- アイコン表示

---

#### 7.2.4 ダッシュボード（Dashboard.tsx）

ユーザーのデータを可視化して表示。

**表示内容**:
1. **グラフセクション**:
   - 気分とモチベーションの推移（MoodChart）
   - 気温と湿度の推移（WeatherChart）

2. **統計パネル**:
   - 総記録数
   - 今週の記録数
   - 平均感情スコア
   - 平均モチベーション

3. **クイックアクション**:
   - 新しい記録の作成
   - 記録一覧の表示

4. **最近の記録**:
   - 直近5件の記録表示

---

#### 7.2.5 記録入力フォーム（RecordForm.tsx）

新しい記録を作成するフォーム。

**入力項目**:
- 睡眠時間・睡眠の質
- 食事の質・食事の規則性
- 運動時間・運動強度
- 感情スコア・感情メモ
- モチベーション
- やったこと

**機能**:
- リアルタイムバリデーション
- 気象データの自動表示
- 送信時のローディング表示
- 成功・エラーメッセージの表示

---

#### 7.2.6 記録一覧（RecordList.tsx）

ユーザーの記録を一覧表示。

**表示内容**:
- 記録日時
- 感情スコア
- モチベーション
- 睡眠・運動・食事のサマリー

**機能**:
- カード形式での表示
- 詳細画面への遷移
- 日付でのソート

---

#### 7.2.7 記録詳細（RecordDetail.tsx）

特定の記録の詳細を表示。

**表示内容**:
- 全ての記録データ
- スコアのバー形式表示
- 関連する気象データ

**機能**:
- 記録の編集（予定）
- 記録の削除
- 一覧へ戻る

---

#### 7.2.8 グラフコンポーネント

**MoodChart.tsx**:
- Chart.jsを使用した折れ線グラフ
- 感情スコアとモチベーションの推移表示
- 過去30日間のデータ

**WeatherChart.tsx**:
- Chart.jsを使用した複合グラフ
- 気温（折れ線）と湿度（棒）の表示
- 過去30日間のデータ

---

### 7.3 サービス層

#### 7.3.1 API設定（api.ts）

Axiosインスタンスの設定とインターセプターの実装。

**機能**:
- ベースURLの設定
- リクエストインターセプター（トークン自動付与）
- レスポンスインターセプター（エラーハンドリング）
- 401エラー時の自動ログアウト

---

#### 7.3.2 認証サービス（authService.ts）

認証関連のAPI呼び出しを管理。

**関数**:
- register(): ユーザー登録
- login(): ログイン
- getCurrentUser(): 現在のユーザー情報取得

---

#### 7.3.3 記録サービス（recordService.ts）

記録関連のAPI呼び出しを管理。

**関数**:
- getRecords(): 記録一覧取得
- getRecordById(): 特定の記録取得
- createRecord(): 記録作成
- updateRecord(): 記録更新
- deleteRecord(): 記録削除
- getRecordStats(): 統計情報取得
- getChartData(): グラフデータ取得

---

### 7.4 型定義

フロントエンドとバックエンドで共通の型定義を使用。

**主要な型**:
- User: ユーザー情報
- Record: 記録データ
- RecordInput: 記録作成時の入力データ
- RecordStats: 統計情報
- ChartData: グラフデータ
- ApiResponse: APIレスポンスのラッパー型

---

### 7.5 スタイリング

CSSモジュールまたは通常のCSSを使用。

**特徴**:
- コンポーネントごとにスタイルを分離
- レスポンシブデザイン（モバイルファースト）
- カラーテーマの統一
- グリッドレイアウトの活用

**主要なブレークポイント**:
- モバイル: 0～768px
- タブレット: 769px～1024px
- デスクトップ: 1025px以上

---

## 8. 認証・認可

### 8.1 認証フロー

#### ユーザー登録フロー

```
1. ユーザーが登録フォームに情報入力
   ↓
2. フロントエンドが /api/auth/register にPOST
   ↓
3. バックエンドがユーザー名・メールの重複チェック
   ↓
4. パスワードをbcryptでハッシュ化
   ↓
5. DBにユーザー情報を保存
   ↓
6. JWTトークンを生成
   ↓
7. ユーザー情報とトークンを返却
   ↓
8. フロントエンドがトークンをlocalStorageに保存
   ↓
9. 自動的にダッシュボードに遷移
```

---

#### ログインフロー

```
1. ユーザーがログインフォームに情報入力
   ↓
2. フロントエンドが /api/auth/login にPOST
   ↓
3. バックエンドがユーザー名でユーザー検索
   ↓
4. bcryptでパスワードを検証
   ↓
5. 検証成功 → JWTトークンを生成
   ↓
6. ユーザー情報とトークンを返却
   ↓
7. フロントエンドがトークンをlocalStorageに保存
   ↓
8. 自動的にダッシュボードに遷移
```

---

#### 保護されたAPIへのアクセスフロー

```
1. フロントエンドがAPIリクエストを送信
   ↓
2. Axiosインターセプターが自動的にトークンを付与
   Header: Authorization: Bearer {token}
   ↓
3. バックエンドの認証ミドルウェアがトークンを検証
   ↓
4. 検証成功 → req.userにユーザー情報を設定
   ↓
5. コントローラーがリクエストを処理
   ↓
6. レスポンスを返却
```

---

### 8.2 JWT（JSON Web Token）

#### トークンの構成

```
Header.Payload.Signature
```

**Payload（ペイロード）**:
```json
{
  "userId": 1,
  "username": "testuser",
  "iat": 1699000000,
  "exp": 1699604800
}
```

**有効期限**: 7日間

---

#### トークンの検証

1. トークンの形式チェック
2. 署名の検証（JWT_SECRETを使用）
3. 有効期限のチェック
4. ペイロードからユーザー情報を抽出

---

### 8.3 セキュリティ対策

#### パスワード管理

- **ハッシュ化**: bcryptを使用（ソルトラウンド: 10）
- **平文保存禁止**: データベースにはハッシュ値のみ保存
- **最小文字数**: 6文字以上

---

#### トークン管理

- **保存場所**: localStorage（XSS対策が必要）
- **自動削除**: ログアウト時、トークン期限切れ時
- **HTTPS推奨**: 本番環境では必須

---

#### API保護

- **認証必須**: ほとんどのエンドポイントで認証が必要
- **CORS設定**: 許可されたオリジンのみアクセス可能
- **レート制限**: 今後実装予定

---

## 9. 外部API連携

### 9.1 WeatherAPI

#### 概要

気象データを取得するための無料API。

**公式サイト**: https://www.weatherapi.com/

---

#### 使用方法

**エンドポイント**:
```
GET https://api.weatherapi.com/v1/current.json
```

**パラメータ**:
- `key`: APIキー
- `q`: 都市名（例: Tokyo）
- `aqi`: 大気質情報（no）

**レスポンス例**:
```json
{
  "location": {
    "name": "Tokyo",
    "country": "Japan"
  },
  "current": {
    "temp_c": 18.0,
    "condition": {
      "text": "Partly cloudy"
    },
    "humidity": 65,
    "pressure_mb": 1013.0
  }
}
```

---

#### 実装

**weatherService.ts**:
```typescript
export async function getCurrentWeather(city: string = 'Tokyo'): Promise<WeatherData | null> {
  try {
    const apiKey = process.env.WEATHER_API_KEY;
    const response = await axios.get<WeatherApiResponse>(
      `https://api.weatherapi.com/v1/current.json`,
      {
        params: {
          key: apiKey,
          q: city,
          aqi: 'no'
        }
      }
    );

    return {
      temperature: response.data.current.temp_c,
      humidity: response.data.current.humidity,
      weatherCondition: response.data.current.condition.text,
      location: response.data.location.name
    };
  } catch (error) {
    console.error('気象データ取得エラー:', error);
    return null;
  }
}
```

---

#### データの保存タイミング

記録作成時に自動的に気象データを取得・保存。

**処理フロー**:
1. ユーザーが記録を作成
2. RecordModel.create()が記録をDBに保存
3. 非同期で getCurrentWeather() を呼び出し
4. 取得した気象データを weather_data テーブルに保存
5. エラーが発生しても記録作成には影響しない

---

### 9.2 Google Gemini API（今後実装予定）

#### 概要

AIによるデータ分析とアドバイス生成に使用。

**用途**:
- 質問の自動生成
- データ傾向の分析
- パーソナライズされたアドバイスの生成

---

#### 実装予定機能

**質問生成**:
- ユーザーのデータ傾向から不足している分析観点を特定
- 適切な質問を自動生成

**データ分析**:
- 過去のデータから傾向を抽出
- 調子の良い日・悪い日のパターン分析
- 気象データとの相関分析

**アドバイス生成**:
- 現在の状態に基づくアドバイス
- 気象予報を考慮した行動提案
- 長期的な改善提案

---

## 10. データフロー

### 10.1 記録作成フロー

```
┌──────────────┐
│ユーザー      │
│記録入力      │
└──────┬───────┘
       │
       │ 1. フォーム送信
       ↓
┌──────────────┐
│RecordForm    │
│(フロント)    │
└──────┬───────┘
       │
       │ 2. POST /api/records
       ↓
┌──────────────┐
│recordService │
│(API呼び出し) │
└──────┬───────┘
       │
       │ 3. HTTPリクエスト
       ↓
┌──────────────┐
│Express Server│
│認証MW→検証MW │
└──────┬───────┘
       │
       │ 4. コントローラー呼び出し
       ↓
┌──────────────┐
│recordController│
│.createRecord()│
└──────┬───────┘
       │
       │ 5. モデル呼び出し
       ↓
┌──────────────┐
│RecordModel   │
│.create()     │
└──────┬───────┘
       │
       │ 6. INSERT文実行
       ↓
┌──────────────┐
│PostgreSQL    │
│records表     │
└──────┬───────┘
       │
       │ 7. 保存完了
       ↓
┌──────────────┐
│非同期で      │
│気象データ取得│
└──────┬───────┘
       │
       │ 8. WeatherAPI呼び出し
       ↓
┌──────────────┐
│WeatherAPI    │
└──────┬───────┘
       │
       │ 9. 気象データ保存
       ↓
┌──────────────┐
│PostgreSQL    │
│weather_data表│
└──────┬───────┘
       │
       │ 10. レスポンス返却
       ↓
┌──────────────┐
│フロントエンド│
│成功メッセージ│
└──────────────┘
```

---

### 10.2 ダッシュボード表示フロー

```
┌──────────────┐
│ユーザー      │
│ダッシュボード│
│アクセス      │
└──────┬───────┘
       │
       │ 1. ページ表示
       ↓
┌──────────────┐
│Dashboard     │
│(フロント)    │
└──────┬───────┘
       │
       │ 2. データ取得開始
       │
       ├──────────┬──────────┐
       │          │          │
       ↓          ↓          ↓
  統計データ   グラフデータ  記録一覧
  GET /stats  GET /chart   GET /records
       │          │          │
       ↓          ↓          ↓
┌──────────────┐ ┌──────────┐ ┌──────────┐
│RecordModel   │ │RecordModel│ │RecordModel│
│.getStats()   │ │.getChart..│ │.findBy...│
└──────┬───────┘ └─────┬────┘ └─────┬────┘
       │               │            │
       │               │            │
       └───────────────┴────────────┘
                       │
                       │ 3. データ集約
                       ↓
               ┌──────────────┐
               │PostgreSQL    │
               │複数テーブル  │
               │結合クエリ    │
               └──────┬───────┘
                      │
                      │ 4. レスポンス返却
                      ↓
               ┌──────────────┐
               │Dashboard     │
               │データ表示    │
               │グラフ描画    │
               └──────────────┘
```

---

### 10.3 認証フロー詳細

```
┌──────────────┐
│ログイン画面  │
└──────┬───────┘
       │
       │ 1. 認証情報送信
       ↓
┌──────────────┐
│POST /api/auth│
│/login        │
└──────┬───────┘
       │
       │ 2. ユーザー検索
       ↓
┌──────────────┐
│UserModel     │
│.findByUsername│
└──────┬───────┘
       │
       │ 3. パスワード検証
       ↓
┌──────────────┐
│bcrypt.compare│
└──────┬───────┘
       │
       │ 4. トークン生成
       ↓
┌──────────────┐
│jwt.sign()    │
└──────┬───────┘
       │
       │ 5. トークン返却
       ↓
┌──────────────┐
│フロントエンド│
│localStorage  │
│保存          │
└──────┬───────┘
       │
       │ 6. 以降のリクエスト
       ↓
┌──────────────┐
│Authorization:│
│Bearer token  │
└──────┬───────┘
       │
       │ 7. トークン検証
       ↓
┌──────────────┐
│認証MW        │
│jwt.verify()  │
└──────┬───────┘
       │
       │ 8. リクエスト処理
       ↓
┌──────────────┐
│コントローラー│
└──────────────┘
```

---

## 11. 主要機能詳細

### 11.1 記録入力機能

#### 機能概要
ユーザーが日々の調子を記録するためのフォーム機能。

#### 入力項目
1. **睡眠**:
   - 睡眠時間（数値入力、小数点1桁）
   - 睡眠の質（1～10段階）

2. **食事**:
   - 食事の質（1～10段階）
   - 食事の規則性（1～10段階）

3. **運動**:
   - 運動時間（分単位）
   - 運動強度（1～10段階）

4. **感情**:
   - 感情スコア（1～10段階）
   - 感情メモ（自由記述）

5. **モチベーション**:
   - モチベーションスコア（1～10段階）

6. **活動内容**:
   - やったこと（自由記述）

#### バリデーションルール
- 全項目が任意入力（少なくとも1項目は入力必須）
- 数値は範囲チェック（1～10）
- 睡眠時間は0～24時間

#### 自動処理
- 記録時刻の自動設定
- 気象データの自動取得・保存
- データベースへの保存

---

### 11.2 ダッシュボード機能

#### 機能概要
ユーザーの記録データを可視化して表示。

#### 表示コンテンツ

**1. グラフセクション**:
- 気分とモチベーションの推移（過去30日）
- 気温と湿度の推移（過去30日）
- Chart.jsによる折れ線グラフと複合グラフ

**2. 統計パネル**:
- 総記録数
- 今週の記録数
- 平均感情スコア
- 平均モチベーション

**3. クイックアクション**:
- 新規記録作成ボタン
- 記録一覧表示ボタン

**4. 最近の記録**:
- 直近5件の記録をカード形式で表示
- 各記録の主要スコアを表示
- クリックで詳細画面に遷移

#### データ更新
- ページ表示時に自動取得
- データ作成・更新後にリフレッシュ

---

### 11.3 記録一覧・詳細機能

#### 一覧画面
- カード形式での表示
- 記録日時、感情、モチベーション、各種スコアのサマリー表示
- 日付降順でソート
- カードクリックで詳細画面に遷移

#### 詳細画面
- 全ての記録データを表示
- スコアをバー形式で視覚化
- 関連する気象データの表示
- 編集・削除機能（予定）
- 一覧に戻るボタン

---

### 11.4 自己分析機能（今後実装予定）

#### 質問表示
- 分析観点ごとの質問を表示
- 10段階評価での回答
- AI生成の質問も表示可能

#### 回答保存
- 記録と紐づけて保存
- 記録とは独立した回答も可能

#### データ分析
- 回答データの蓄積
- 傾向分析
- 相関関係の抽出

---

### 11.5 アドバイス機能（今後実装予定）

#### アドバイス生成
- AIによる自動生成
- 現在の状態に基づく提案
- 気象予報を考慮した行動提案

#### 表示タイミング
- ダッシュボード上に常時表示
- 記録作成後に表示
- 定期的な更新

#### フィードバック
- 役立ったかの評価
- AIの改善に活用

---

### 11.6 気象データ連携機能

#### 自動取得
- 記録作成時に自動実行
- WeatherAPIからデータ取得
- 非同期処理で実行（メイン処理に影響なし）

#### 保存データ
- 気温、湿度、気圧
- 天気の状態
- 位置情報
- 季節

#### データ活用
- グラフでの可視化
- 記録との相関分析
- アドバイス生成時の考慮要素

---

## 12. 今後の拡張予定

### 12.1 短期的な実装予定

1. **自己分析質問機能の完全実装**:
   - AI質問生成
   - 回答画面の実装
   - データ分析の強化

2. **アドバイス機能の実装**:
   - Gemini API連携
   - プロンプト設計
   - アドバイス表示UI

3. **記録の編集機能**:
   - 編集画面の実装
   - 更新API完成

4. **データエクスポート機能**:
   - CSV出力
   - PDF出力

---

### 12.2 中期的な実装予定

1. **通知機能**:
   - 記録リマインダー
   - 定期的なアドバイス配信

2. **グラフの強化**:
   - より多様なグラフタイプ
   - カスタマイズ可能な期間選択
- フィルタリング機能

3. **レポート機能**:
   - 週次・月次レポートの自動生成
   - PDF出力

4. **目標設定機能**:
   - 個人目標の設定
   - 達成度の追跡

---

### 12.3 長期的な実装予定

1. **ソーシャル機能**:
   - 他のユーザーとのデータ共有（匿名化）
   - コミュニティ機能

2. **ウェアラブルデバイス連携**:
   - Fitbit、Apple Watchなどとの連携
   - 自動データ取得

3. **AI精度向上**:
   - ユーザーフィードバックの活用
   - パーソナライズの強化

4. **多言語対応**:
   - 英語、その他の言語への対応

---

## 13. まとめ

本システムは、React + TypeScript のフロントエンドと Node.js + Express + PostgreSQL のバックエンドで構成される、AIを活用した調子記録Webアプリケーションである。

**主要な特徴**:
- JWT認証による安全なユーザー管理
- RESTful APIによる明確な責任分離
- PostgreSQLによる堅牢なデータ管理
- Chart.jsによる直感的なデータ可視化
- 外部APIとの連携（気象データ、AI分析）
- スケーラブルなアーキテクチャ設計

**技術的な強み**:
- TypeScriptによる型安全性
- MVCパターンによる保守性の高い設計
- 非同期処理による高いパフォーマンス
- レスポンシブデザインによるマルチデバイス対応

本定義書は、システムの全体像を理解し、今後の開発や保守を円滑に進めるための基礎資料として活用されることを想定している。

---

**文書バージョン**: 1.0  
**作成日**: 2025年11月7日  
**最終更新日**: 2025年11月7日
