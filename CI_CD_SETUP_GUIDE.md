# CI/CD設定ガイド

このドキュメントでは、GitHub Actionsを使用したCI/CDパイプラインの設定方法を説明します。

## 概要

このプロジェクトでは、GitHub Actionsを使用して以下の自動化を実現します。

- フロントエンド：Vitestによるユニットテスト、PlaywrightによるE2Eテスト、ビルド確認
- バックエンド：Jestによるユニットテスト、テストカバレッジ計測、ビルド確認

## GitHubリポジトリの準備

### 1. GitHubリポジトリの作成

まず、GitHubにプロジェクトのリポジトリを作成します。

```bash
# プロジェクトディレクトリに移動
cd E:\ReactProject

# Gitリポジトリの初期化（まだの場合）
git init

# リモートリポジトリの追加
git remote add origin https://github.com/YOUR_USERNAME/mood-tracker.git

# 初回コミット
git add .
git commit -m "Initial commit: Add CI/CD workflows"
git branch -M main
git push -u origin main
```

### 2. ブランチ戦略

このプロジェクトでは以下のブランチ戦略を推奨します。

- `main`：本番環境用のブランチ。安定したコードのみをマージ
- `develop`：開発環境用のブランチ。機能開発はここにマージ
- `feature/*`：機能開発用のブランチ。開発完了後にdevelopへマージ

ワークフローは`main`と`develop`ブランチへのプッシュおよびプルリクエストでトリガーされます。

## ワークフローの説明

### フロントエンドCI（frontend-ci.yml）

#### トリガー条件

- `main`または`develop`ブランチへのプッシュ
- `main`または`develop`ブランチへのプルリクエスト
- `mood-tracker-app/`ディレクトリ内のファイル変更時のみ実行

#### 実行ジョブ

**1. test ジョブ**

ユニットテストとE2Eテストを実行します。

- Node.js 20環境のセットアップ
- 依存関係のインストール（npm ci）
- Vitestによるユニットテスト実行
- Playwrightブラウザのインストール
- PlaywrightによるE2Eテスト実行
- テスト結果とスクリーンショットのアーティファクト保存

**2. build ジョブ**

ビルドが成功するか確認します。testジョブが成功した場合のみ実行されます。

- Node.js 20環境のセットアップ
- 依存関係のインストール
- ビルド実行（npm run build）
- ビルド成果物のアーティファクト保存

#### アーティファクト

テスト実行後、以下のアーティファクトがGitHub上に保存されます。

- `playwright-report`：Playwrightのテストレポート（30日間保存）
- `playwright-screenshots`：テスト失敗時のスクリーンショット（30日間保存）
- `build-output`：ビルド成果物（7日間保存）

### バックエンドCI（backend-ci.yml）

#### トリガー条件

- `main`または`develop`ブランチへのプッシュ
- `main`または`develop`ブランチへのプルリクエスト
- `mood-tracker-api/`ディレクトリ内のファイル変更時のみ実行

#### 実行ジョブ

**1. test ジョブ**

PostgreSQLサービスコンテナを起動し、ユニットテストを実行します。

- PostgreSQL 15コンテナの起動
- Node.js 20環境のセットアップ
- 依存関係のインストール
- テスト用データベースのセットアップ（migration.sqlの実行）
- Jestによるユニットテスト実行
- テストカバレッジレポートの生成
- カバレッジレポートのアーティファクト保存

**2. build ジョブ**

ビルドが成功するか確認します。testジョブが成功した場合のみ実行されます。

- Node.js 20環境のセットアップ
- 依存関係のインストール
- TypeScriptビルド実行

#### アーティファクト

テスト実行後、以下のアーティファクトがGitHub上に保存されます。

- `coverage-report`：テストカバレッジレポート（30日間保存）

## 環境変数の設定

### フロントエンド

フロントエンドのE2Eテストでは、以下の環境変数が必要です。

現時点では、テスト用に固定値を使用しているため、GitHub Secretsの設定は不要です。本番環境のAPIエンドポイントに対してテストを実行する場合は、以下の環境変数を設定します。

```
VITE_API_URL: バックエンドAPIのURL（例：https://your-api.onrender.com）
```

設定方法：
1. GitHubリポジトリの「Settings」→「Secrets and variables」→「Actions」
2. 「New repository secret」をクリック
3. Nameに`VITE_API_URL`、Secretに値を入力

### バックエンド

バックエンドのテストでは、PostgreSQLサービスコンテナを使用するため、GitHub Secretsの設定は不要です。ワークフロー内で以下の環境変数が自動的に設定されます。

```
DATABASE_URL: postgresql://postgres:postgres@localhost:5432/mood_tracker_test
JWT_SECRET: test-secret-key-for-ci
NODE_ENV: test
```

## ワークフローの実行確認

### 1. コードのプッシュ

ワークフローをトリガーするには、mainまたはdevelopブランチにコードをプッシュします。

```bash
git add .
git commit -m "Add new feature"
git push origin main
```

### 2. GitHubでの確認

GitHubリポジトリの「Actions」タブで、ワークフローの実行状況を確認できます。

- 実行中のワークフローは黄色のアイコンで表示されます
- 成功したワークフローは緑色のチェックマークで表示されます
- 失敗したワークフローは赤色のXマークで表示されます

### 3. ログの確認

各ジョブの詳細ログを確認するには、ワークフロー実行をクリックし、各ジョブ名をクリックします。ステップごとの実行ログが表示されます。

### 4. アーティファクトのダウンロード

テストレポートやカバレッジレポートは、ワークフロー実行ページの下部「Artifacts」セクションからダウンロードできます。

## トラブルシューティング

### E2Eテストが失敗する場合

E2Eテストは環境に依存するため、以下の点を確認してください。

1. **タイムアウトの調整**：GitHub Actionsの環境は比較的低速なため、待機時間を長めに設定する必要があります。
2. **スクリーンショットの確認**：失敗時のスクリーンショットをアーティファクトからダウンロードし、画面の状態を確認します。
3. **ヘッドレスモードの問題**：Playwrightはデフォルトでヘッドレスモードで実行されます。ローカルでは動作するがCI環境で失敗する場合、ヘッドレスモードでのテストをローカルでも確認してください。

```bash
# ヘッドレスモードでローカル実行
npm run test:e2e
```

### PostgreSQLコンテナが起動しない場合

PostgreSQLサービスコンテナが正しく起動しない場合、以下を確認してください。

1. **ヘルスチェック**：ワークフローにはヘルスチェックが設定されています。ログでヘルスチェックの状態を確認してください。
2. **ポート競合**：デフォルトで5432ポートを使用します。他のサービスと競合していないか確認してください。

### ビルドが失敗する場合

TypeScriptのビルドエラーが発生する場合、以下を確認してください。

1. **型エラー**：ローカルで`npm run build`を実行し、型エラーがないか確認してください。
2. **依存関係**：package-lock.jsonが最新であることを確認してください。

## ベストプラクティス

### 1. プルリクエストベースの開発

mainやdevelopブランチへの直接プッシュは避け、プルリクエストを通じてコードをマージします。これにより、マージ前にテストが実行され、コードの品質が担保されます。

### 2. ブランチ保護ルールの設定

mainブランチに対して、以下のブランチ保護ルールを設定することを推奨します。

- プルリクエストによるレビューを必須とする
- ステータスチェック（テスト）が成功するまでマージを禁止する
- 管理者も含めてルールを強制する

設定方法：
1. GitHubリポジトリの「Settings」→「Branches」
2. 「Branch protection rules」で「Add rule」をクリック
3. Branch name patternに`main`を入力
4. 「Require status checks to pass before merging」をチェック
5. 「Require branches to be up to date before merging」をチェック
6. Status checksで`test`と`build`を選択

### 3. テストの高速化

E2Eテストは実行時間が長くなりがちです。以下の方法で高速化を検討してください。

- テストの並列実行：Playwrightは複数のワーカーでテストを並列実行できます
- 不要なテストのスキップ：重要度の低いテストは、mainブランチへのマージ時のみ実行するよう設定します
- キャッシュの活用：npm依存関係のキャッシュは既に設定済みです

### 4. シークレットの管理

API キーやパスワードなどの機密情報は、必ずGitHub Secretsで管理してください。コード内にハードコーディングしてはいけません。

## 今後の拡張

現在のCI/CDパイプラインは、テストとビルド確認のみを行っています。以下のような拡張が考えられます。

### 自動デプロイメント

テストが成功した場合に自動的にデプロイを実行する設定を追加できます。

**Vercelへの自動デプロイ（フロントエンド）**

Vercelは、GitHubリポジトリと連携することで、プッシュ時に自動デプロイが可能です。GitHub Actionsでの設定は不要で、Vercelダッシュボードで設定します。

**Render.comへの自動デプロイ（バックエンド）**

Render.comも同様に、GitHubリポジトリと連携することで自動デプロイが可能です。

これらのサービスを使用する場合、GitHub Actionsでのテスト成功後に、各サービスの自動デプロイ機能を利用することを推奨します。

### コードカバレッジの可視化

テストカバレッジを可視化するサービス（Codecov、Coverallsなど）を導入することで、コードのテスト網羅率を継続的に追跡できます。

### リントとフォーマットチェック

ESLintやPrettierを使用したコード品質チェックをワークフローに追加できます。

## まとめ

このCI/CD設定により、コードの品質を継続的に担保し、バグの早期発見が可能になります。プッシュやプルリクエストのたびに自動的にテストが実行されるため、手動テストの負担が大幅に軽減されます。

設定完了後は、「Actions」タブでワークフローの実行状況を定期的に確認し、失敗したテストがあれば速やかに対処してください。
